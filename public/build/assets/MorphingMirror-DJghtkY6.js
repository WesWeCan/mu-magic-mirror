var ue=Object.defineProperty;var ge=(P,s,t)=>s in P?ue(P,s,{enumerable:!0,configurable:!0,writable:!0,value:t}):P[s]=t;var C=(P,s,t)=>(ge(P,typeof s!="symbol"?s+"":s,t),t);import{d as le,l as W,m as ce,o as N,g as B,b as M,F as q,s as J,Q as ve,p as we,q as fe,a as pe,h as H,u as se,x as xe,e as ie,t as ne}from"./app-CF6YtaFa.js";import{r as ye,l as ae,a as re}from"./Tables-D2og9A1K.js";import{S as _e,q as be,N as Ce,U as ke}from"./body-segmentation.esm-e5hd8SBe.js";import{M as Me}from"./Mirror-CN5XbZut.js";class Pe{constructor(){C(this,"drawCanvas",!1);C(this,"canvasses",null);C(this,"bodySegmenter",null);C(this,"bodySegmentationModel",_e.MediaPipeSelfieSegmentation);C(this,"bodySegmentationModelConfig",{architecture:"ResNet50",outputStride:16,quantBytes:4});C(this,"bodySegmentationConfig",{multiSegmentation:!1,segmentBodyParts:!0,flipHorizontal:!1,internalResolution:"medium",segmentationThreshold:.7,maxDetections:1,scoreThreshold:.2,nmsRadius:20,minKeypointScore:.5,refineSteps:20});C(this,"cutouts",[]);C(this,"div_video",null);C(this,"video",null);C(this,"div_process",null);C(this,"canvas_process",null);C(this,"mousePos",{x:0,y:0});C(this,"getPixelData",async s=>{let t=await s.mask.toImageData();const o=t.width;t.height;const e=t.data;let i=[];for(let a=0;a<e.length;a+=4){let r={x:a/4%o,y:Math.floor(a/4/o),color:{r:e[a],g:e[a+1],b:e[a+2],a:e[a+3]}};i.push(r)}return i});C(this,"getBoundingBoxesRaw",async s=>{let t={};for(let o in ae){let e=s.filter(i=>i.color.r===parseInt(o));if(e.length>0){let i=e.reduce((n,l)=>l.x<n?l.x:n,e[0].x),a=e.reduce((n,l)=>l.x>n?l.x:n,e[0].x),r=e.reduce((n,l)=>l.y<n?l.y:n,e[0].y),d=e.reduce((n,l)=>l.y>n?l.y:n,e[0].y);t[ae[o]]={minX:i,maxX:a,minY:r,maxY:d}}}return console.log("Raw part bounding boxes:",t),t});C(this,"getBoundingBoxesCombinations",async s=>{let t={};for(let o in re){let e=s.filter(i=>re[o].includes(i.color.r));if(e.length>0){let i=e.reduce((n,l)=>l.x<n?l.x:n,e[0].x),a=e.reduce((n,l)=>l.x>n?l.x:n,e[0].x),r=e.reduce((n,l)=>l.y<n?l.y:n,e[0].y),d=e.reduce((n,l)=>l.y>n?l.y:n,e[0].y);t[o]={minX:i,maxX:a,minY:r,maxY:d,pixels:e}}}return t});C(this,"drawMaskOnCanvas",async(s,t,o)=>{const e=await be(s,ke,{r:255,g:255,b:255,a:0});await Ce(o,t,e,1,0)});C(this,"drawRawBoxes",async(s,t)=>{let o=document.createElement("canvas");if(!o){console.error("No img canvas");return}o.width=s.width,o.height=s.height;let e=o.getContext("2d");if(!e){console.error("No img ctx");return}e.drawImage(s,0,0,s.width,s.height),e.strokeStyle="red",e.lineWidth=2;for(let i in t){let{minX:a,maxX:r,minY:d,maxY:n}=t[i];e.strokeRect(a,d,r-a,n-d)}});C(this,"drawCombinedBoxes",async(s,t)=>{let o=document.createElement("canvas");if(!o){console.error("No img canvas");return}o.width=s.width,o.height=s.height;let e=o.getContext("2d");if(!e){console.error("No img ctx");return}e.drawImage(s,0,0,s.width,s.height),e.strokeStyle="green",e.lineWidth=2;for(let i in t){let{minX:a,maxX:r,minY:d,maxY:n}=t[i];e.strokeRect(a,d,r-a,n-d)}});C(this,"extractCutouts",async(s,t)=>{let o=document.createElement("canvas");if(!o){console.error("No img canvas");return}o.width=s.width,o.height=s.height;let e=o.getContext("2d");if(!e){console.error("No img ctx");return}e.drawImage(s,0,0,s.width,s.height);let i=[];for(let a in t){let{minX:r,maxX:d,minY:n,maxY:l}=t[a],u=document.createElement("canvas");u.width=d-r,u.height=l-n;let f=u.getContext("2d");if(!f){console.error("No part ctx");return}f.drawImage(s,r,n,d-r,l-n,0,0,d-r,l-n);let p={part:a,img:u.toDataURL()};i.push(p)}return console.log("cutouts",i),i});console.log("ImageProcessor constructor")}async init(s,t){return console.log("init"),await ye(),await this.getMediaStream(s),console.log("Got media stream"),await this.createCanvasses(t),console.log("Canvasses created"),new Promise((o,e)=>{o(!0)})}async getMediaStream(s){if(!s){console.error("No video div");return}this.div_video=s;const t=document.createElement("video");if(t.width=640,t.height=480,t.muted=!0,navigator.mediaDevices.getUserMedia({video:!0}).then(o=>{t.srcObject=o}),await new Promise(o=>{t.onloadedmetadata=()=>{console.log("Video metadata loaded"),o(!0)}}),t.play(),!t){console.error("No video");return}return this.video=t,await new Promise(o=>{t.addEventListener("loadeddata",()=>{console.log("Video loaded"),o(!0)})}),new Promise(o=>{o(!0)})}async createCanvasses(s){if(!s){console.error("No div process");return}this.div_process=s;const t=document.createElement("canvas");return t.id="canvas_process",t.width=this.div_process.clientWidth,t.height=this.div_process.clientHeight,this.canvas_process=t,this.div_process.appendChild(t),this.canvas_process.addEventListener("mousemove",o=>{this.mousePos={x:o.offsetX,y:o.offsetY}}),this.canvas_process.addEventListener("mouseleave",o=>{this.mousePos={x:-1,y:-1}}),this.canvas_process.addEventListener("click",o=>{this.mousePos={x:o.offsetX,y:o.offsetY}}),new Promise(o=>{o(!0)})}async draw(){var t,o,e,i;if(!this.video){console.error("No video");return}if(!this.canvas_process){console.error("No canvas process");return}(this.canvas_process.width!==((t=this.div_process)==null?void 0:t.clientWidth)||this.canvas_process.height!==((o=this.div_process)==null?void 0:o.clientHeight))&&(this.canvas_process.width=((e=this.div_process)==null?void 0:e.clientWidth)||640,this.canvas_process.height=((i=this.div_process)==null?void 0:i.clientHeight)||480);const s=this.canvas_process.getContext("2d");if(!s){console.error("No ctx");return}this.drawVideo(s)}async drawVideo(s){if(!this.video){console.error("No video");return}if(!this.canvas_process){console.error("No canvas process");return}const t=this.video.videoWidth/this.video.videoHeight,o=this.canvas_process.width/this.canvas_process.height;let e,i,a,r;t>o?(e=this.canvas_process.height*t,i=this.canvas_process.height,a=(this.canvas_process.width-e)/2,r=0):(e=this.canvas_process.width,i=this.canvas_process.width/t,a=0,r=(this.canvas_process.height-i)/2),s.drawImage(this.video,a,r,e,i)}async getBoundingBoxFromMousePos(){if(!this.canvas_process){console.error("No canvas process");return}if(this.mousePos.x==-1&&this.mousePos.y==-1)return;const s=this.canvas_process.width*.3;let t=this.mousePos.x-s/2,o=this.mousePos.y-s/2;return t<0?t=0:t+s>this.canvas_process.width&&(t=this.canvas_process.width-s),o<0?o=0:o+s>this.canvas_process.height&&(o=this.canvas_process.height-s),{x:t,y:o,width:s,height:s}}async takePicture(){var o,e,i,a;if(!this.video){console.error("No video");return}if(!this.canvas_process){console.error("No canvas process");return}(this.canvas_process.width!==((o=this.div_process)==null?void 0:o.clientWidth)||this.canvas_process.height!==((e=this.div_process)==null?void 0:e.clientHeight))&&(this.canvas_process.width=((i=this.div_process)==null?void 0:i.clientWidth)||640,this.canvas_process.height=((a=this.div_process)==null?void 0:a.clientHeight)||480);const s=this.canvas_process.getContext("2d");if(!s){console.error("No ctx");return}this.drawVideo(s);const t=this.canvas_process.toDataURL();return new Promise((r,d)=>{r(t)})}async takePictureAndSlice(){if(!this.video)return console.error("No video"),new Promise((a,r)=>{r("No video")});if(!this.canvas_process)return console.error("No canvas process"),new Promise((a,r)=>{r("No canvas process")});let s=this.canvas_process.getContext("2d");if(!s)return console.error("No ctx"),new Promise((a,r)=>{r("No ctx")});let t=await this.getBoundingBoxFromMousePos();if(!t)return console.error("No bounding box"),new Promise((a,r)=>{r("No bounding box")});this.drawVideo(s);let o=document.createElement("canvas");o.width=t.width,o.height=t.height;let e=o.getContext("2d");if(!e)return console.error("No part ctx"),new Promise((a,r)=>{r("No part ctx")});e.drawImage(this.canvas_process,t.x,t.y,t.width,t.height,0,0,t.width,t.height);let i={part:"part",img:o.toDataURL()};return console.log("cutOut",i),new Promise((a,r)=>{a(i)})}async takePictureAndProcess(){const s=await this.takePicture();if(!s)return console.error("No image"),new Promise((o,e)=>{e("No image")});const t=await this.processImage(s);return console.log("cutouts",t),new Promise((o,e)=>{!t||t.length===0?e([]):o(t)})}async readAndDrawSegmented(){if(!this.video){console.error("No video");return}if(!this.canvas_process){console.error("No canvas process");return}if(!this.bodySegmenter){console.error("No bodySegmenter");return}const s=this.canvas_process.getContext("2d");if(!s){console.error("No ctx");return}s.drawImage(this.video,0,0,this.canvas_process.width,this.canvas_process.height)}async processImage(s){console.log("processImage");let t=[],o=await this.drawMasksFromImgData(s);return o&&t.push(...o),console.log("total cutouts",t),new Promise((e,i)=>{e(t)})}async detectHumans(s){if(!this.cocoSsdModel){console.error("cocoSsdModel is not loaded");return}const t=await this.cocoSsdModel.detect(s,50,.6);console.log("predictions",t);const o=t.filter(e=>e.class==="person");return this.drawCanvas&&this.drawBoundingBoxesFromObjectDetection(s,t),new Promise((e,i)=>{e(o)})}async drawBoundingBoxesFromObjectDetection(s,t){let o=document.createElement("canvas");o.width=s.width,o.height=s.height;let e=o.getContext("2d");if(!e){console.error("ctx is null");return}e.drawImage(s,0,0,s.width,s.height),t.forEach(i=>{const{bbox:a}=i,[r,d,n,l]=a;e.beginPath(),e.rect(r,d,n,l),i.class==="person"?e.strokeStyle="green":e.strokeStyle="red",e.lineWidth=2,e.stroke(),e.beginPath(),e.measureText(i.class).width,e.rect(r,d-20,n,20),e.fillStyle="black",e.fill(),e.font="16px Arial",e.fillStyle="white",e.fillText(`${i.class} (${Math.round(i.score*100)}%)`,r,d-10),e.fillStyle="black",e.fill(),e.font="16px Arial",e.fillStyle="white",e.fillText(`${i.class} (${Math.round(i.score*100)}%)`,r,d-10)})}async splitCanvasIntoPersons(s,t){const o=[];return t.forEach((e,i)=>{let a=document.createElement("canvas");a.width=e.bbox[2],a.height=e.bbox[3];let r=a.getContext("2d");if(!r){console.error("No ctx");return}r.drawImage(s,e.bbox[0],e.bbox[1],e.bbox[2],e.bbox[3],0,0,e.bbox[2],e.bbox[3]),o.push(a.toDataURL())}),new Promise((e,i)=>{e(o)})}async getSegmentationFromImage(s){if(!this.bodySegmenter){console.error("bodySegmenter is not loaded");return}const t=await this.bodySegmenter.segmentPeople(s);return new Promise((o,e)=>{o(t)})}async drawMasksFromImgData(s){const t=new Image;t.src=s,await new Promise(i=>{t.onload=i});const o=await this.getSegmentationFromImage(t);if(!o){console.error("No segmentation");return}let e=[];for(let i=0;i<o.length;i++){const a=o[i];let r=await this.getPixelData(a);await this.getBoundingBoxesRaw(r);let d=await this.getBoundingBoxesCombinations(r),n=document.createElement("canvas");n.width=t.width,n.height=t.height;let l=await this.extractCutouts(t,d);l&&e.push(...l)}return console.log("cutouts",e),this.cutouts.push(...e),new Promise((i,a)=>{i(e)})}}const Se=["src","alt"],Ne=le({__name:"Camera",emits:["newSlice"],setup(P,{emit:s}){const t=new Pe,o=W(null),e=W(null),i=s;ce(async()=>{o.value&&e.value&&(await t.init(o.value,e.value),e.value.addEventListener("click",d=>{t.takePictureAndSlice().then(n=>{n!=null&&i("newSlice",n)})}),requestAnimationFrame(a))});const a=()=>{o.value&&e.value&&(t.draw(),requestAnimationFrame(a))},r=W([]);return(d,n)=>(N(),B(q,null,[M("div",{ref_key:"video_container",ref:o,class:"video-container"},null,512),M("div",{ref_key:"div_process",ref:e,class:"div-process"},null,512),(N(!0),B(q,null,J(r.value,l=>(N(),B("div",{key:l.part},[M("img",{src:l.img,alt:l.part},null,8,Se)]))),128))],64))}}),Be=async(P,s,t,o)=>{console.log("corpse",P),console.log(s.clientHeight);const e=document.createElement("canvas");e.id="collage-canvas",e.width=o.x,e.height=o.y,s.innerHTML="",s==null||s.appendChild(e);const i=e.getContext("2d");if(!i){console.error("no ctx");return}let a=Object.keys(P);if(t.length>0){let g=a[Math.floor(Math.random()*a.length)],_=t[Math.floor(Math.random()*t.length)],v=P[g],R=new Image;R.src=_.img,await new Promise(me=>{R.onload=()=>{me()}}),R.width,R.height,v.label;const O={...v,path:_.img,base_image:{...v.base_image,path:_.img}},Q={...P,[g]:O},j=[...a],U=j.indexOf(g);U!==-1&&j.splice(U,1),j.push(g),P=Q,a=j}console.log("keys",a);let r=[];for(let g=0;g<a.length;g++){const _=a[g],v=P[_],R=new Image;R.src=v.path,await new Promise(U=>{R.onload=()=>{U()}});const O=R.width,Q=R.height,j=_;r.push({img:R,width:O,height:Q,label:j})}r=r.sort(()=>Math.random()-.5);const d=e.width,n=e.height,l={x:d/2,y:n/2};let u={};for(let g=0;g<r.length;g++){const _=r[g];let v=_.width;_.width=d,_.height=_.height*(_.width/v),u[_.label]=_}console.log("pieces",r),i.fillStyle="gray",i.fillRect(0,0,d,n);let f=0,p=0,h=0,m=0,w="empty",E=.05,b={min:.9,max:1.1},A=1,x=0,y=0,c={},I=1,T=10,S=0,k=!1,X=.15,F=.15;for(w="middle",I=u[w].height/u[w].width,x=d*(Math.random()*(.65-.45)+.45),y=x*I,h=x*A,m=y*(h/x),f=l.x-h/2,p=l.y-m/2,i.fillStyle="red",i.fillRect(f,p,h,m),c[w]={x:f,y:p,width:h,height:m},w="top",I=u[w].height/u[w].width,y=c.middle.y-0-n*E,x=y/I,m=y*A,h=x*(m/y),k=!1,S=0,F=0,X=.35,b={min:.65,max:.85};!k&&S<T;)h=c.middle.width*(Math.random()*(b.max-b.min)+b.min),m=h*(y/x),f=Math.random()*(c.middle.width-h)+c.middle.x,p=c.middle.y-m,p+=m*X*Math.random(),k=!0,S++;if(!k){console.error("Could not find a valid position");return}for(i.fillStyle="blue",i.fillRect(f,p,h,m),c[w]={x:f,y:p,width:h,height:m},w="left",I=u[w].height/u[w].width,x=c.middle.x-0-d*E,y=x*I,h=x*A,m=y*(h/x),k=!1,S=0,F=.35,b={min:.65,max:.85};!k&&S<T;)m=c.middle.height*(Math.random()*(b.max-b.min)+b.min),h=m*(x/y),p=Math.random()*(c.middle.height-m)+c.middle.y,f=c.middle.x-h,f+=h*F*Math.random(),k=!0,S++;if(!k){console.error("Could not find a valid position");return}for(i.fillStyle="green",i.fillRect(f,p,h,m),c[w]={x:f,y:p,width:h,height:m},w="right",I=u[w].height/u[w].width,x=d-c.middle.x-c.middle.width-d*E,y=x*I,h=x*A,m=y*(h/x),k=!1,S=0,F=.65,b={min:.65,max:.85};!k&&S<T;)m=c.middle.height*(Math.random()*(b.max-b.min)+b.min),h=m*(x/y),p=Math.random()*(c.middle.height-m)+c.middle.y,f=c.middle.x+c.middle.width,f-=h*F*Math.random(),k=!0,S++;if(!k){console.error("Could not find a valid position");return}i.fillStyle="purple",i.fillRect(f,p,h,m),c[w]={x:f,y:p,width:h,height:m},w="low",I=u[w].height/u[w].width;let Z=(n-c.middle.y-c.middle.height-n*E/2)/2;for(y=Z,x=y/I,m=y*A,h=x*(m/y),k=!1,S=0,X=.55,b={min:.65,max:.85};!k&&S<T;)h=c.middle.width*(Math.random()*(b.max-b.min)+b.min),m=h*(y/x),f=Math.random()*(c.middle.width-h)+c.middle.x,p=c.middle.y+c.middle.height,p-=m*X*Math.random(),k=!0,S++;if(!k){console.error("Could not find a valid position");return}for(i.fillStyle="yellow",i.fillRect(f,p,h,m),c[w]={x:f,y:p,width:h,height:m},w="lowlow",I=u[w].height/u[w].width,y=Z,x=y/I,m=y*A,h=x*(m/y),k=!1,S=0,X=.5,b={min:.65,max:.85};!k&&S<T;)h=c.low.width*(Math.random()*(b.max-b.min)+b.min),m=h*(y/x),f=Math.random()*(c.low.width-h)+c.low.x,p=c.low.y+c.low.height,p-=m*X*Math.random(),k=!0,S++;i.fillStyle="orange",i.fillRect(f,p,h,m),c[w]={x:f,y:p,width:h,height:m};let Y=Object.keys(c),K=1/0,z=1/0;for(let g=0;g<Y.length;g++){const _=Y[g],v=c[_];v.x<K&&(K=v.x),v.y<z&&(z=v.y)}for(let g=0;g<Y.length;g++){const _=Y[g],v=c[_];v.x-=K,v.y-=z}let $=document.createElement("canvas"),L=0,D=0;for(let g=0;g<Y.length;g++){const _=Y[g],v=c[_];v.x+v.width>L&&(L=v.x+v.width),v.y+v.height>D&&(D=v.y+v.height)}$.width=L,$.height=D,console.log("totalWidth",L),console.log("totalHeight",D);let ee=$.getContext("2d");if(!ee){console.error("no buffer ctx");return}let V=["middle","top","left","right","low","lowlow"];V=V.sort(()=>Math.random()-.5);for(let g=0;g<V.length;g++){const _=V[g],v=c[_];let R=v.x,O=v.y;ee.drawImage(u[_].img,R,O,v.width*A,v.height*A)}let G=1;E=.05,(L>d-d*E||D>n-n*E)&&(G=Math.min((d-d*E)/L,(n-n*E)/D));let te=L*G,oe=D*G,de=(d-te)/2,he=(n-oe)/2;return i.fillStyle="gray",i.fillRect(0,0,d,n),i.drawImage($,de,he,te,oe),new Promise(g=>{g()})},Ie={class:"morphing-mirror-layout"},Re=M("header",null,[M("h1",null,"MU - Morphing Mirror")],-1),Ee=["hidden"],Ae=M("span",{class:"hint"}," Click on the video to capture a slice ",-1),Le={key:0,class:"slices"},De=["hidden"],He=["hidden"],We={class:"list-container"},Xe=M("h2",null,"Used slices",-1),Ye=M("br",null,null,-1),je=M("footer",null,"(alpha test)",-1),Te=3,Ge=le({__name:"MorphingMirror",setup(P){new Me;const s=W(null),t=ve(),o=W([]),e=W("camera");ce(async()=>{document.body.classList.add("mirror"),await we()}),fe(()=>{document.body.classList.remove("mirror")});const i=W(!1),a=async()=>{if(i.value)return;if(i.value=!0,!s.value){console.error("no collage container");return}if(!t.props.corpse){console.error("no corpse");return}let n=document.getElementById("canvas_process");if(!n){console.error("no container");return}let l={x:n.offsetWidth,y:n.offsetHeight};await Be(t.props.corpse,s.value,o.value,l),e.value="collage",i.value=!1},r=n=>{o.value.unshift(n),o.value.length>Te&&o.value.pop()},d=()=>{window.location.reload()};return(n,l)=>(N(),B("div",Ie,[Re,M("main",null,[M("div",{class:"screen",hidden:e.value!="camera"},[Ae,pe(Ne,{onNewSlice:r}),o.value.length?(N(),B("div",Le,[(N(!0),B(q,null,J(o.value,u=>(N(),B("div",{key:u.part,class:"slice",style:xe(`background-image: url('${u.img}')`)},null,4))),128))])):H("",!0),o.value.length?(N(),B("button",{key:1,class:"collage-button",onClick:a},"Make Collage")):H("",!0)],8,Ee),M("div",{class:"screen",hidden:e.value!="collage"},[M("div",{ref_key:"collage_container",ref:s,class:"collage collage-container"},null,512),o.value.length?(N(),B("button",{key:0,class:"redo-button",onClick:l[0]||(l[0]=u=>e.value="camera")},"Go back")):H("",!0),o.value.length?(N(),B("button",{key:1,class:"start-over-button",onClick:l[1]||(l[1]=u=>d())},"Start over with new corpse")):H("",!0),o.value.length?(N(),B("button",{key:2,class:"list-button",onClick:l[2]||(l[2]=u=>e.value="list")},"List")):H("",!0)],8,De),M("div",{class:"screen",hidden:e.value!="list"},[M("div",We,[Xe,se(t).props.corpse?(N(!0),B(q,{key:0},J(se(t).props.corpse,u=>(N(),B("div",{key:u.id,class:"list-item"},[M("span",null,[ie(" Name:"),Ye,ie(" "+ne(u.base_image.name??"no name"),1)]),M("span",null," Link: "+ne(u.base_image.link??"no link"),1)]))),128)):H("",!0)]),o.value.length?(N(),B("button",{key:0,class:"list-button",onClick:l[3]||(l[3]=u=>e.value="collage")},"Go Back")):H("",!0)],8,He)]),je]))}});export{Ge as default};
