var me=Object.defineProperty;var ge=(e,s,n)=>s in e?me(e,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[s]=n;var P=(e,s,n)=>(ge(e,typeof s!="symbol"?s+"":s,n),n);import{d as se,l as T,m as le,o as S,g as D,b as x,F as U,s as J,Q as ue,p as ve,q as fe,a as pe,h as R,u as oe,x as we,e as ne,t as ae}from"./app-BVy8CyRw.js";import{r as ye}from"./register_all_kernels-BwOSmF9o.js";import{k as _e,S as ke}from"./body-segmentation.esm-D2El9hp6.js";import{m as be,s as xe,M as Ce}from"./Mirror-Cguib4MA.js";const Me=async e=>{await ye(),console.log("Tensorflow ready"),console.log("Setting up inferences"),e.inference.bodyPix=void 0;const s=await _e(ke.BodyPix);e.inference.bodyPix=s,console.log("BodyPix ready"),e.inference.blazePose=void 0;const n={runtime:"tfjs",enableSmoothing:!0,modelType:"lite"},c=await be(xe.BlazePose,n);e.inference.blazePose=c,console.log("BlazePose ready")},Ie=async e=>{(await navigator.mediaDevices.getUserMedia({video:!0})).getTracks().forEach(g=>g.stop());const a=(await navigator.mediaDevices.enumerateDevices()).filter(g=>g.kind==="videoinput").map(g=>({device:g,capabilities:g.getCapabilities()}));console.log(a);const l=a.find(g=>g.device.label.includes("back"))||a[0];e.availableVideoDevices=a,e.currentVideoDeviceId=l.device.deviceId,console.log("Current video device: "+l.device.label)},Pe=async e=>{if(!e.currentVideoDeviceId){console.error("No current video device");return}e.availableVideoDevices.find(a=>a.device.deviceId===e.currentVideoDeviceId);const n=(e.availableVideoDevices.findIndex(a=>a.device.deviceId===e.currentVideoDeviceId)+1)%e.availableVideoDevices.length,c=e.availableVideoDevices[n];e.currentVideoDeviceId=c.device.deviceId,console.log("Switching video device to: "+c.device.label),re(e,e.div_video)},re=async(e,s)=>{if(!s){console.error("No video div");return}e.video&&(e.video.srcObject.getTracks().forEach(g=>g.stop()),e.video.pause(),e.video.srcObject=null,e.video=null,s.innerHTML=""),e.div_video=s;const n=document.createElement("video");n.width=640,n.height=480,n.muted=!0,s.innerHTML="",s.appendChild(n),console.log("Getting media stream"),console.log(e.availableVideoDevices);const c={video:{deviceId:e.currentVideoDeviceId?{exact:e.currentVideoDeviceId}:void 0}};if(navigator.mediaDevices.getUserMedia(c).then(a=>{n.srcObject=a}),await new Promise(a=>{n.onloadedmetadata=()=>{console.log("Video metadata loaded"),a(!0)}}),n.play(),!n){console.error("No video");return}return e.video=n,await new Promise(a=>{n.addEventListener("loadeddata",()=>{console.log("Video loaded"),a(!0)})}),new Promise(a=>{a(!0)})},Be=async(e,s,n)=>{var l,g;if(!s){console.error("No div process");return}e.div_process=s;const c=document.createElement("canvas");if(c.id="canvas_process",c.width=((l=e.video)==null?void 0:l.videoWidth)||0,c.height=((g=e.video)==null?void 0:g.videoHeight)||0,e.canvas_process=c,e.div_process.appendChild(c),!n){console.error("No div render");return}e.div_render=n;const a=document.createElement("canvas");return a.id="canvas_render",a.width=e.div_render.clientWidth,a.height=e.div_render.clientHeight,e.canvas_render=a,e.div_render.appendChild(a),new Promise(w=>{w(!0)})},Se=async(e,s)=>{},De=async e=>{if(!e.canvas_process){console.error("No canvas");return}const s=e.canvas_process,n=s.getContext("2d");if(!n){console.error("No context");return}n.clearRect(0,0,s.width,s.height)},Ve=async e=>{if(!e.canvas_process||!e.video){console.error("No canvas or video");return}const s=e.canvas_process,n=s.getContext("2d");if(!n){console.error("No context");return}n.drawImage(e.video,0,0,s.width,s.height)},He=async e=>{await De(e),await Ve(e)};class Ne{constructor(){P(this,"drawCanvas",!1);P(this,"canvasses",null);P(this,"cutouts",[]);P(this,"div_video",null);P(this,"video",null);P(this,"div_process",null);P(this,"canvas_process",null);P(this,"div_render",null);P(this,"canvas_render",null);P(this,"mousePos",{x:0,y:0});P(this,"availableVideoDevices",[]);P(this,"currentVideoDeviceId");P(this,"inference",{bodyPix:void 0,blazePose:void 0,cocoSsd:void 0,selfieSegmentation:void 0});P(this,"inferenceData",{poses:void 0,bodyPixSegmentation:void 0,coloredPartImage:void 0,pixels:void 0,maskData:void 0,detectedOjects:void 0,humans:void 0});P(this,"boundingBoxes",[]);console.log("ImageProcessor constructor")}async init(s,n,c){return console.log("init"),await Me(this),console.log("Inferences setup"),await Ie(this),console.log("Got available video devices"),await re(this,s),console.log("Got media stream"),await Be(this,n,c),console.log("Canvasses created"),new Promise((a,l)=>{a(!0)})}async switchVideoDevice(){await Pe(this)}async loop(){if(!this.video||!this.canvas_process){console.error("No video or canvas");return}await Se(this,this.video),await this.draw(),await this.render()}async draw(){await He(this)}async render(){if(!this.canvas_process||!this.canvas_render){console.error("No canvas or rendering canvas");return}const s=this.canvas_process,n=this.canvas_render,c=n.getContext("2d"),a=s.getContext("2d");if(!c||!a){console.error("No context");return}const l=s.width/s.height,g=n.height,w=g*l,y=(n.width-w)/2;c.drawImage(s,y,0,w,g)}}const Te=["src","alt"],Le=se({__name:"Camera",emits:["newSlice","pictureTaken"],setup(e,{emit:s}){const n=new Ne,c=T(null),a=T(null),l=T(null),g=s;le(async()=>{c.value&&a.value&&l.value&&(await n.init(c.value,a.value,l.value),requestAnimationFrame(w))});const w=async()=>{c.value&&a.value&&(await n.loop(),requestAnimationFrame(w))},y=T([]),I=()=>{n.switchVideoDevice()},v=()=>{console.log("take photo"),console.log(n.boundingBoxes),g("pictureTaken",n.boundingBoxes)};return(t,r)=>(S(),D(U,null,[x("div",{ref_key:"video_container",ref:c,class:"video-container"},null,512),x("div",{ref_key:"div_process",ref:a,class:"div-process"},null,512),x("div",{ref_key:"div_render",ref:l,class:"div-render"},null,512),x("button",{class:"switch-device-button",onClick:I},"Switch Device"),x("div",{class:"take-photo-button",onClick:v},"Take Photo"),(S(!0),D(U,null,J(y.value,i=>(S(),D("div",{key:i.part},[x("img",{src:i.img,alt:i.part},null,8,Te)]))),128))],64))}}),We=async(e,s,n,c)=>{console.log("corpse",e),console.log(s.clientHeight);const a=document.createElement("canvas");a.id="collage-canvas",a.width=c.x,a.height=c.y,s.innerHTML="",s==null||s.appendChild(a);const l=a.getContext("2d");if(!l){console.error("no ctx");return}let g=Object.keys(e);if(n.length>0){let u=g[Math.floor(Math.random()*g.length)],b=n[Math.floor(Math.random()*n.length)],f=e[u],H=new Image;H.src=b.img,await new Promise(he=>{H.onload=()=>{he()}}),H.width,H.height,f.label;const X={...f,path:b.img,base_image:{...f.base_image,path:b.img}},Q={...e,[u]:X},j=[...g],G=j.indexOf(u);G!==-1&&j.splice(G,1),j.push(u),e=Q,g=j}console.log("keys",g);let w=[];for(let u=0;u<g.length;u++){const b=g[u],f=e[b],H=new Image;H.src=f.path,await new Promise(G=>{H.onload=()=>{G()}});const X=H.width,Q=H.height,j=b;w.push({img:H,width:X,height:Q,label:j})}w=w.sort(()=>Math.random()-.5);const y=a.width,I=a.height,v={x:y/2,y:I/2};let t={};for(let u=0;u<w.length;u++){const b=w[u];let f=b.width;b.width=y,b.height=b.height*(b.width/f),t[b.label]=b}console.log("pieces",w),l.fillStyle="gray",l.fillRect(0,0,y,I);let r=0,i=0,o=0,d=0,m="empty",C=.05,p={min:.9,max:1.1},N=1,_=0,k=0,h={},V=1,O=10,B=0,M=!1,E=.15,Y=.15;for(m="middle",V=t[m].height/t[m].width,_=y*(Math.random()*(.65-.45)+.45),k=_*V,o=_*N,d=k*(o/_),r=v.x-o/2,i=v.y-d/2,l.fillStyle="red",l.fillRect(r,i,o,d),h[m]={x:r,y:i,width:o,height:d},m="top",V=t[m].height/t[m].width,k=h.middle.y-0-I*C,_=k/V,d=k*N,o=_*(d/k),M=!1,B=0,Y=0,E=.35,p={min:.75,max:1};!M&&B<O;)o=h.middle.width*(Math.random()*(p.max-p.min)+p.min),d=o*(k/_),r=Math.random()*(h.middle.width-o)+h.middle.x,i=h.middle.y-d,i+=d*E*Math.random(),M=!0,B++;if(!M){console.error("Could not find a valid position");return}for(l.fillStyle="blue",l.fillRect(r,i,o,d),h[m]={x:r,y:i,width:o,height:d},m="left",V=t[m].height/t[m].width,_=h.middle.x-0-y*C,k=_*V,o=_*N,d=k*(o/_),M=!1,B=0,Y=.35,p={min:.75,max:1};!M&&B<O;)o=h.middle.width*(Math.random()*(p.max-p.min)+p.min),d=o*(k/_),i=Math.random()*(h.middle.height-d)+h.middle.y,r=h.middle.x-o,r+=o*Y*Math.random(),M=!0,B++;if(!M){console.error("Could not find a valid position");return}for(l.fillStyle="green",l.fillRect(r,i,o,d),h[m]={x:r,y:i,width:o,height:d},m="right",V=t[m].height/t[m].width,_=y-h.middle.x-h.middle.width-y*C,k=_*V,o=_*N,d=k*(o/_),M=!1,B=0,Y=.65,p={min:.75,max:1};!M&&B<O;)o=h.middle.width*(Math.random()*(p.max-p.min)+p.min),d=o*(k/_),i=Math.random()*(h.middle.height-d)+h.middle.y,r=h.middle.x+h.middle.width,r-=o*Y*Math.random(),M=!0,B++;if(!M){console.error("Could not find a valid position");return}l.fillStyle="purple",l.fillRect(r,i,o,d),h[m]={x:r,y:i,width:o,height:d},m="low",V=t[m].height/t[m].width;let Z=(I-h.middle.y-h.middle.height-I*C/2)/2;for(k=Z,_=k/V,d=k*N,o=_*(d/k),M=!1,B=0,E=.55,p={min:.75,max:1};!M&&B<O;)o=h.middle.width*(Math.random()*(p.max-p.min)+p.min),d=o*(k/_),r=Math.random()*(h.middle.width-o)+h.middle.x,i=h.middle.y+h.middle.height,i-=d*E*Math.random(),M=!0,B++;if(!M){console.error("Could not find a valid position");return}for(l.fillStyle="yellow",l.fillRect(r,i,o,d),h[m]={x:r,y:i,width:o,height:d},m="lowlow",V=t[m].height/t[m].width,k=Z,_=k/V,d=k*N,o=_*(d/k),M=!1,B=0,E=.5,p={min:.75,max:1};!M&&B<O;)o=h.low.width*(Math.random()*(p.max-p.min)+p.min),d=o*(k/_),r=Math.random()*(h.low.width-o)+h.low.x,i=h.low.y+h.low.height,i-=d*E*Math.random(),M=!0,B++;l.fillStyle="orange",l.fillRect(r,i,o,d),h[m]={x:r,y:i,width:o,height:d};let A=Object.keys(h),F=1/0,q=1/0;for(let u=0;u<A.length;u++){const b=A[u],f=h[b];f.x<F&&(F=f.x),f.y<q&&(q=f.y)}for(let u=0;u<A.length;u++){const b=A[u],f=h[b];f.x-=F,f.y-=q}let z=document.createElement("canvas"),L=0,W=0;for(let u=0;u<A.length;u++){const b=A[u],f=h[b];f.x+f.width>L&&(L=f.x+f.width),f.y+f.height>W&&(W=f.y+f.height)}z.width=L,z.height=W,console.log("totalWidth",L),console.log("totalHeight",W);let ee=z.getContext("2d");if(!ee){console.error("no buffer ctx");return}let $=["middle","top","left","right","low","lowlow"];$=$.sort(()=>Math.random()-.5);for(let u=0;u<$.length;u++){const b=$[u],f=h[b];let H=f.x,X=f.y;ee.drawImage(t[b].img,H,X,f.width*N,f.height*N)}let K=1;C=.05,(L>y-y*C||W>I-I*C)&&(K=Math.min((y-y*C)/L,(I-I*C)/W));let te=L*K,ie=W*K,de=(y-te)/2,ce=(I-ie)/2;return l.fillStyle="gray",l.fillRect(0,0,y,I),l.drawImage(z,de,ce,te,ie),new Promise(u=>{u()})},Re=async(e,s,n,c)=>{console.log("createCollageBoundingBoxes"),console.log("corpse",e),console.log("collage_container",s);const a=document.createElement("canvas");a.width=c.x,a.height=c.y,a.id="collage-canvas",s.innerHTML="",s.appendChild(a);const l=a.getContext("2d");if(!l){console.error("No context");return}let g=Object.keys(e);console.log("keys",g);let w=[];for(let v=0;v<g.length;v++){const t=g[v],r=e[t],i=new Image;i.src=r.path,await new Promise(C=>{i.onload=()=>{C()}});const o=i.width,d=i.height,m=t;w.push({img:i,width:o,height:d,label:m})}w=w.sort(()=>Math.random()-.5),console.log("pieces",w);const y=n.filter(v=>v.x!==1/0&&v.y!==1/0&&v.width!==1/0&&v.height!==1/0);console.log("filteredBoundingBoxes",y);const I=y.map(v=>{switch(v.label){case"head_mask":return"top";case"torso_mask":return"middle";case"right_arm_mask":return"right";case"left_arm_mask":return"left";case"left_leg_mask":case"right_leg_mask":case"left_foot_mask":case"right_foot_mask":case"left_hand_mask":case"right_hand_mask":return!1;default:return!1}});console.log("pieceLabels",I);for(let v=0;v<y.length;v++){const t=y[v];let r=!1,i=null;switch(l.strokeStyle="blue",l.strokeRect(t.x,t.y,t.width,t.height),t.label){case"head_mask":if(r="top",i=w.find(o=>o.label===r),i){const o=Math.min(t.width/i.width,t.height/i.height),d=i.width*o,m=i.height*o,C=t.x+(t.width-d)/2,p=t.y+(t.height-m)/2;l.drawImage(i.img,C,p,d,m)}break;case"torso_mask":if(r="middle",i=w.find(o=>o.label===r),i){const o=Math.min(t.width/i.width,t.height/i.height),d=i.width*o,m=i.height*o,C=t.x+(t.width-d)/2,p=t.y+(t.height-m)/2;l.drawImage(i.img,C,p,d,m)}break;case"right_arm_mask":if(r="right",i=w.find(o=>o.label===r),i){const o=Math.min(t.width/i.width,t.height/i.height),d=i.width*o,m=i.height*o,C=t.x+(t.width-d)/2,p=t.y+(t.height-m)/2;l.drawImage(i.img,C,p,d,m)}break;case"left_arm_mask":if(r="left",i=w.find(o=>o.label===r),i){const o=Math.min(t.width/i.width,t.height/i.height),d=i.width*o,m=i.height*o,C=t.x+(t.width-d)/2,p=t.y+(t.height-m)/2;l.drawImage(i.img,C,p,d,m)}break;case"left_leg_mask":case"right_leg_mask":case"left_foot_mask":case"right_foot_mask":case"left_hand_mask":case"right_hand_mask":r=!1;default:r=!1}}},Ee={class:"morphing-mirror-layout"},Ae=x("header",null,[x("h1",null,"MU - Morphing Mirror")],-1),je=["hidden"],Oe=x("span",{class:"hint"}," Click on the video to capture a slice ",-1),Ye={key:0,class:"slices"},Xe=["hidden"],ze=["hidden"],$e={class:"list-container"},Ge=x("h2",null,"Used slices",-1),Ue=x("br",null,null,-1),Fe=x("footer",null,"(alpha test)",-1),qe=3,nt=se({__name:"MorphingMirror",setup(e){new Ce;const s=T(null),n=ue(),c=T([]),a=T("camera");le(async()=>{document.body.classList.add("mirror"),await ve()}),fe(()=>{document.body.classList.remove("mirror")});const l=T(!1),g=async()=>{if(l.value)return;if(l.value=!0,!s.value){console.error("no collage container");return}if(!n.props.corpse){console.error("no corpse");return}let v=document.getElementById("canvas_process");if(!v){console.error("no container");return}let t={x:v.offsetWidth,y:v.offsetHeight};await We(n.props.corpse,s.value,c.value,t),a.value="collage",l.value=!1},w=v=>{c.value.unshift(v),c.value.length>qe&&c.value.pop()},y=()=>{window.location.reload()},I=async v=>{if(console.log("picture taken",v),l.value)return;if(l.value=!0,!s.value){console.error("no collage container");return}if(!n.props.corpse){console.error("no corpse");return}let t=document.getElementById("canvas_process");if(!t){console.error("no container");return}let r={x:t.offsetWidth,y:t.offsetHeight};await Re(n.props.corpse,s.value,v,r),a.value="collage",l.value=!1};return(v,t)=>(S(),D("div",Ee,[Ae,x("main",null,[x("div",{class:"screen",hidden:a.value!="camera"},[Oe,pe(Le,{onNewSlice:w,onPictureTaken:I}),c.value.length?(S(),D("div",Ye,[(S(!0),D(U,null,J(c.value,r=>(S(),D("div",{key:r.part,class:"slice",style:we(`background-image: url('${r.img}')`)},null,4))),128))])):R("",!0),c.value.length?(S(),D("button",{key:1,class:"collage-button",onClick:g},"Make Collage")):R("",!0)],8,je),x("div",{class:"screen",hidden:a.value!="collage"},[x("div",{ref_key:"collage_container",ref:s,class:"collage collage-container"},null,512),c.value.length?(S(),D("button",{key:0,class:"redo-button",onClick:t[0]||(t[0]=r=>a.value="camera")},"Go back")):R("",!0),c.value.length?(S(),D("button",{key:1,class:"start-over-button",onClick:t[1]||(t[1]=r=>y())},"Start over with new corpse")):R("",!0),c.value.length?(S(),D("button",{key:2,class:"list-button",onClick:t[2]||(t[2]=r=>a.value="list")},"List")):R("",!0)],8,Xe),x("div",{class:"screen",hidden:a.value!="list"},[x("div",$e,[Ge,oe(n).props.corpse?(S(!0),D(U,{key:0},J(oe(n).props.corpse,r=>(S(),D("div",{key:r.id,class:"list-item"},[x("span",null,[ne(" Name:"),Ue,ne(" "+ae(r.base_image.name??"no name"),1)]),x("span",null," Link: "+ae(r.base_image.link??"no link"),1)]))),128)):R("",!0)]),c.value.length?(S(),D("button",{key:0,class:"list-button",onClick:t[3]||(t[3]=r=>a.value="collage")},"Go Back")):R("",!0)],8,ze)]),Fe]))}});export{nt as default};
