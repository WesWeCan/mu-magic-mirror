var Ge=Object.defineProperty;var Fe=(t,a,d)=>a in t?Ge(t,a,{enumerable:!0,configurable:!0,writable:!0,value:d}):t[a]=d;var L=(t,a,d)=>(Fe(t,typeof a!="symbol"?a+"":a,d),d);import{d as Be,Q as Le,l as E,m as He,o as S,g as W,b as D,F as fe,s as xe,p as qe,q as Ke,a as Qe,h as X,t as ke,x as Je}from"./app-Bt6mra0n.js";import{r as Ze}from"./register_all_kernels-BiFiLXma.js";import{m as et,s as tt,M as it}from"./Mirror-McvnpZDJ.js";const ot=async t=>{await Ze(),console.log("Tensorflow ready"),t.inference.blazePose=void 0;const a={runtime:"tfjs",enableSmoothing:!0,modelType:"lite"},d=await et(tt.BlazePose,a);t.inference.blazePose=d,console.log("BlazePose ready")},st=async t=>{(await navigator.mediaDevices.getUserMedia({video:!0})).getTracks().forEach(h=>h.stop());const o=(await navigator.mediaDevices.enumerateDevices()).filter(h=>h.kind==="videoinput").map(h=>({device:h,capabilities:h.getCapabilities()}));console.log(o);const l=o.find(h=>h.device.label.includes("back"))||o[0];t.availableVideoDevices=o,t.currentVideoDeviceId=l.device.deviceId,console.log("Current video device: "+l.device.label)},nt=async t=>{if(!t.currentVideoDeviceId){console.error("No current video device");return}t.availableVideoDevices.find(o=>o.device.deviceId===t.currentVideoDeviceId);const d=(t.availableVideoDevices.findIndex(o=>o.device.deviceId===t.currentVideoDeviceId)+1)%t.availableVideoDevices.length,g=t.availableVideoDevices[d];t.currentVideoDeviceId=g.device.deviceId,console.log("Switching video device to: "+g.device.label),Se(t,t.div_video)},Se=async(t,a)=>{if(!a){console.error("No video div");return}if(t.video){const o=t.video.srcObject;o&&o.getTracks().forEach(l=>l.stop()),t.video.pause(),t.video.srcObject=null,t.video=null,a.innerHTML=""}t.div_video=a;const d=document.createElement("video");d.width=640,d.height=480,d.muted=!0,d.setAttribute("playsinline","true"),d.style.objectFit="cover",a.innerHTML="",a.appendChild(d),console.log("Getting media stream"),console.log(t.availableVideoDevices);const g={video:{deviceId:t.currentVideoDeviceId?{exact:t.currentVideoDeviceId}:void 0,width:{ideal:640},height:{ideal:480}}};try{const o=await navigator.mediaDevices.getUserMedia(g);d.srcObject=o}catch(o){console.error("Error accessing media devices.",o);return}if(await new Promise(o=>{d.onloadedmetadata=()=>{console.log("Video metadata loaded"),o(!0)}}),d.play(),!d){console.error("No video element available");return}return t.video=d,await new Promise(o=>{d.addEventListener("loadeddata",()=>{console.log("Video loaded"),o(!0)})}),new Promise(o=>{o(!0)})},at=async(t,a,d)=>{var h,f;if(!a){console.error("No div process");return}t.div_process=a;const g=document.createElement("canvas");if(g.id="canvas_process",g.width=((h=t.video)==null?void 0:h.videoWidth)||0,g.height=((f=t.video)==null?void 0:f.videoHeight)||0,t.canvas_process=g,t.div_process.appendChild(g),!d){console.error("No div render");return}t.div_render=d;const o=document.createElement("canvas");if(o.id="canvas_render",o.width=t.div_render.clientWidth,o.height=t.div_render.clientHeight,t.canvas_render=o,t.div_render.appendChild(o),!o.getContext("2d")){console.error("No context");return}return new Promise(y=>{y(!0)})},lt=async(t,a)=>{if(!a||!t.inference.blazePose){console.error("No video or inference");return}const d={flipHorizontal:!1,maxPoses:1},g=performance.now(),l=await t.inference.blazePose.estimatePoses(a,d,g);return t.inferenceData.poses=l,l},Ce={head:[0,1,2,3,4,5,6,7,8,9,10],torso:[11,12,24,23],right_arm:[12,14,16],left_arm:[11,13,15],right_leg:[24,26,28,32],left_leg:[23,25,27,31],right_hand:[16,18,20,22],left_hand:[15,17,19,21],right_foot:[28,30,32],left_foot:[27,29,31],legs:[23,24,25,26,27,28,29,30,31,32]},rt=async(t,a,d=void 0)=>{for(const g of a){const o=g.keypoints,l=g.keypoints3D||[];ct(t,o,l,d)}},ct=async(t,a,d,g=void 0)=>{var l,h;t.boundingBoxes=[],t.inferenceData.pixels,(l=t.inferenceData.maskData)==null||l.width,(h=t.inferenceData.maskData)==null||h.height;const o=Object.keys(Ce);for(let f of o){const y=f,u=[],n=[];for(const b of Ce[y])u.push(a[b]),n.push(d[b]);const r=Math.min(...u.map(b=>b.x)),i=Math.min(...u.map(b=>b.y)),e=Math.max(...u.map(b=>b.x)),c=Math.max(...u.map(b=>b.y)),s=e-r,p=c-i,v={x:r,y:i,width:s,height:p,keypoints:u,keypoints3D:n,label:`${y}_pose`};t.boundingBoxes.push(v)}},dt=async t=>{t.boundingBoxesProcessed=[];const a=t.boundingBoxes.find(w=>w.label==="head_pose"),d=t.boundingBoxes.find(w=>w.label==="torso_pose"),g=t.boundingBoxes.find(w=>w.label==="right_arm_pose"),o=t.boundingBoxes.find(w=>w.label==="left_arm_pose"),l=t.boundingBoxes.find(w=>w.label==="right_leg_pose"),h=t.boundingBoxes.find(w=>w.label==="left_leg_pose"),f=t.boundingBoxes.find(w=>w.label==="right_hand_pose"),y=t.boundingBoxes.find(w=>w.label==="left_hand_pose"),u=t.boundingBoxes.find(w=>w.label==="right_foot_pose"),n=t.boundingBoxes.find(w=>w.label==="left_foot_pose");if(!a||!d||!g||!o||!l||!h||!f||!y||!u||!n){console.error("Some bounding boxes are undefined");return}const r=d.width*.7,i=r*1.05,e=a.x-(r-a.width)/2,c=a.y-(i-a.height)/2,s={x:e,y:c,width:r,height:i,keypoints:a.keypoints,keypoints3D:a.keypoints3D,label:"head_processed"};t.boundingBoxesProcessed.push(s);const p=r*.9,v=i*.55,b=e-(p-r)/2,T=c-i*.35,k={x:b,y:T,width:p,height:v,keypoints:a.keypoints,keypoints3D:a.keypoints3D,label:"hair_processed"};t.boundingBoxesProcessed.push(k);const _=i*1.25,m=d.height*1.25,H=d.x-(_-d.width)/2,j=d.y-(m-d.height)/2,B={x:H,y:j,width:_,height:m,keypoints:d.keypoints,keypoints3D:d.keypoints3D,label:"torso_processed"};t.boundingBoxesProcessed.push(B);const C=g.keypoints.find(w=>w.name==="right_shoulder"),$=g.keypoints.find(w=>w.name==="right_elbow"),A=g.keypoints.find(w=>w.name==="right_wrist");g.keypoints.find(w=>w.name==="right_thumb");let F=g.width*1.05,q=Math.abs(C.y-$.y)+Math.abs($.y-A.y)*1.35;const te=.5,U=.5;q<i*te&&(q=i*te),F<r*U&&(F=r*U);const O=g.x-(F-g.width)/2,K=g.y-(q-g.height)/2,Q={x:O,y:K,width:F,height:q,keypoints:g.keypoints,keypoints3D:g.keypoints3D,label:"right_arm_processed"};t.boundingBoxesProcessed.push(Q);const J=o.keypoints.find(w=>w.name==="left_shoulder"),R=o.keypoints.find(w=>w.name==="left_elbow"),Y=o.keypoints.find(w=>w.name==="left_wrist");o.keypoints.find(w=>w.name==="left_thumb");let G=o.width*1.45,N=Math.abs(J.y-R.y)+Math.abs(R.y-Y.y)*1.35;N<i*te&&(N=i*te),G<r*U&&(G=r*U);const ie=o.x-(G-o.width)/2,oe=o.y-(N-o.height)/2,ge={x:ie,y:oe,width:G,height:N,keypoints:o.keypoints,keypoints3D:o.keypoints3D,label:"left_arm_processed"};t.boundingBoxesProcessed.push(ge);const I=.5;let se=f.width*3,x=f.height*1.5;se<r*I&&(se=r*I),x<r*I&&(x=r*I);const P=f.x-(se-f.width)/2,M=f.y-(x-f.height)/2,V={x:P,y:M,width:se,height:x,keypoints:f.keypoints,keypoints3D:f.keypoints3D,label:"right_hand_processed"};t.boundingBoxesProcessed.push(V);let z=y.width*3,Z=y.height*1.5;z<r*I&&(z=r*I),Z<r*I&&(Z=r*I);const ee=y.x-(z-y.width)/2,ne=y.y-(Z-y.height)/2,ue={x:ee,y:ne,width:z,height:Z,keypoints:y.keypoints,keypoints3D:y.keypoints3D,label:"left_hand_processed"};t.boundingBoxesProcessed.push(ue);const We=l.keypoints.find(w=>w.name==="right_hip"),Me=l.keypoints.find(w=>w.name==="right_knee"),Te=l.keypoints.find(w=>w.name==="right_ankle");l.keypoints.find(w=>w.name==="right_foot_index");let ae=l.width*1.35,le=Math.abs(We.y-Me.y)+Math.abs(Me.y-Te.y)*1.35;ae<r*I&&(ae=r*I),le<r*I&&(le=r*I);const _e=l.x-(ae-l.width)/2,we=l.y-(le-l.height)/2,Ve={x:_e,y:we,width:ae,height:le,keypoints:l.keypoints,keypoints3D:l.keypoints3D,label:"right_leg_processed"};t.boundingBoxesProcessed.push(Ve);const Re=h.keypoints.find(w=>w.name==="left_hip"),De=h.keypoints.find(w=>w.name==="left_knee"),Ye=h.keypoints.find(w=>w.name==="left_ankle");h.keypoints.find(w=>w.name==="left_foot_index");let re=h.width*1.35,ce=Math.abs(Re.y-De.y)+Math.abs(De.y-Ye.y)*1.35;re<r*I&&(re=r*I),ce<r*I&&(ce=r*I);const ye=h.x-(re-h.width)/2,ve=h.y-(ce-h.height)/2,Ne={x:ye,y:ve,width:re,height:ce,keypoints:h.keypoints,keypoints3D:h.keypoints3D,label:"left_leg_processed"};t.boundingBoxesProcessed.push(Ne);let pe=u.width*1.5,de=u.height*1.5;pe<r*I&&(pe=r*I),de<r*I&&(de=r*I);const Xe=u.x-(pe-u.width)/2,Ee=u.y-(de-u.height)/2,$e={x:Xe,y:Ee,width:pe,height:de,keypoints:u.keypoints,keypoints3D:u.keypoints3D,label:"right_foot_processed"};t.boundingBoxesProcessed.push($e);let me=n.width*1.5,he=n.height*1.5;me<r*I&&(me=r*I),he<r*I&&(he=r*I);const Oe=n.x-(me-n.width)/2,je=n.y-(he-n.height)/2,Ae={x:Oe,y:je,width:me,height:he,keypoints:n.keypoints,keypoints3D:n.keypoints3D,label:"left_foot_processed"};t.boundingBoxesProcessed.push(Ae);const Ie=Math.min(ye,_e),Pe=Math.min(ve,we),ze=Math.max(ye+re,_e+ae)-Ie;let be=Math.max(ve+ce,we+le)-Pe;be=be-(he+de)/2;const Ue={x:Ie,y:Pe,width:ze,height:be,keypoints:[...h.keypoints,...l.keypoints],keypoints3D:[...h.keypoints3D,...l.keypoints3D],label:"legs"};t.boundingBoxesProcessed.push(Ue)},ht=async(t,a)=>{await lt(t,a),t.inferenceData.poses&&(await rt(t,t.inferenceData.poses),await dt(t))},gt=async t=>{if(!t.canvas_process){console.error("No canvas");return}const a=t.canvas_process,d=a.getContext("2d");if(!d){console.error("No context");return}d.clearRect(0,0,a.width,a.height),d.fillStyle="rgb(255, 255, 255)",d.fillRect(0,0,a.width,a.height)},pt=async t=>{if(!t.canvas_process||!t.boundingBoxesProcessed){console.error("No canvas or bounding boxes");return}const d=t.canvas_process.getContext("2d");if(!d){console.error("No context");return}let g=t.boundingBoxesProcessed,o=t.pieces;const l=100,h=new Date().getTime();h-t.lastDraw>l&&(o=o.sort(()=>Math.random()-.5),t.lastDraw=h,t.lastDraw=h),g=g.sort(()=>{const i=performance.now();return Math.sin(i/l)-.5});const y=g.filter(i=>i.x!==1/0&&i.y!==1/0&&i.width!==1/0&&i.height!==1/0),u={head_processed:"bottom",torso_processed:"center",right_arm_processed:"right",left_arm_processed:"left",right_leg_processed:"top",left_leg_processed:"top",right_foot_processed:"top",left_foot_processed:"top",right_hand_processed:"top",left_hand_processed:"top",hair_processed:"bottom",legs:"top"};let n={},r={img:new Image,baseImage:{name:"YOU!",link:"#"},width:0,height:0};for(let i=0;i<y.length;i++){const e=y[i];let c=!1,s=null;if(d.strokeStyle="blue",c=e.label.replace("_processed",""),s=o.find(p=>p.label===c),s){let p=!1;if(Math.random()<.05&&s&&c!=="torso"){p=!0;const b=await ft(t,e);b&&(r.img=b,r.width=e.width,r.height=e.height)}switch(u[e.label]){case"top":const b=Math.min(e.width/s.width,e.height/s.height),T=s.width*b,k=s.height*b,_=e.x+(e.width-T)/2,m=e.y;n[e.label]={x:_,y:m,width:T,height:k};break;case"bottom":const H=Math.min(e.width/s.width,e.height/s.height),j=s.width*H,B=s.height*H,C=e.x+(e.width-j)/2,$=e.y+e.height-B;n[e.label]={x:C,y:$,width:j,height:B};break;case"center":const A=Math.min(e.width/s.width,e.height/s.height),F=s.width*A,q=s.height*A,te=e.x+(e.width-F)/2,U=e.y+(e.height-q)/2;n[e.label]={x:te,y:U,width:F,height:q};break;case"right":const O=Math.min(e.width/s.width,e.height/s.height),K=s.width*O,Q=s.height*O,J=e.x+e.width-K,R=e.y+(e.height-Q)/2;n[e.label]={x:J,y:R,width:K,height:Q};break;case"left":const Y=Math.min(e.width/s.width,e.height/s.height),G=s.width*Y,N=s.height*Y,ie=e.x,oe=e.y+(e.height-N)/2;n[e.label]={x:ie,y:oe,width:G,height:N};break}p?(n[e.label].img=r.img,n[e.label].baseImage=r.baseImage):(n[e.label].img=s.img,n[e.label].baseImage=s.baseImage)}}t.currentlyShownPieces=n,Object.keys(n).forEach(i=>{const e=n[i],c=e.x,s=e.y,p=e.width,v=e.height;d.drawImage(e.img,c,s,p,v),mt(d,c,s,p,v)}),Object.keys(n).forEach(i=>{const e=n[i],c=e.x,s=e.y;e.width;const p=e.height;d.font="12px Arial",d.fillStyle="blue",d.fillText(e.baseImage.name,c,s+p+15)})},mt=(t,a,d,g,o)=>{const h=[2,4];t.beginPath(),t.setLineDash(h),t.strokeStyle="blue",t.lineWidth=2,t.rect(a,d,g,o),t.stroke(),t.setLineDash([])},ft=async(t,a)=>{if(!t.video||!t.canvas_process){console.error("No video or canvas");return}if(!t.canvas_process.getContext("2d")){console.error("No context");return}const o=t.video;if(a.x<0||a.y<0||a.width<0||a.height<0)return;let l=document.createElement("canvas");l.width=a.width,l.height=a.height;let h=l.getContext("2d");if(!h){console.error("No context");return}h.drawImage(o,a.x,a.y,a.width,a.height,0,0,a.width,a.height),h.getImageData(0,0,a.width,a.height);let f=new Image;return f.src=l.toDataURL(),await new Promise(y=>{f.onload=()=>{y(!0)}}),l=null,h=null,f},ut=async t=>{await gt(t),await pt(t)};class _t{constructor(){L(this,"running",!0);L(this,"canvasses",null);L(this,"cutouts",[]);L(this,"div_video",null);L(this,"video",null);L(this,"div_process",null);L(this,"canvas_process",null);L(this,"div_render",null);L(this,"canvas_render",null);L(this,"mousePos",{x:0,y:0});L(this,"availableVideoDevices",[]);L(this,"currentVideoDeviceId");L(this,"lastDraw",0);L(this,"inference",{bodyPix:void 0,blazePose:void 0,cocoSsd:void 0,selfieSegmentation:void 0});L(this,"inferenceData",{poses:void 0,bodyPixSegmentation:void 0,coloredPartImage:void 0,pixels:void 0,maskData:void 0,detectedOjects:void 0,humans:void 0});L(this,"boundingBoxes",[]);L(this,"boundingBoxesProcessed",[]);L(this,"pieces",[]);L(this,"currentlyShownPieces",{});console.log("ImageProcessor constructor")}async init(a,d,g,o){return console.log("init"),await ot(this),console.log("Inferences setup"),await st(this),console.log("Got available video devices"),await Se(this,a),console.log("Got media stream"),await at(this,d,g),console.log("Canvasses created"),await this.loadPieces(o),console.log("Pieces loaded"),new Promise((l,h)=>{l(!0)})}async loadPieces(a){let d=performance.now(),g=Object.keys(a);console.log("keys",g),console.log("corpse",a);let o=[];for(let h=0;h<g.length;h++){const f=g[h],y=a[f];for(let u=0;u<y.length;u++){const n=y[u],r=new Image;r.src=n.path,await new Promise(s=>{r.onload=()=>{s()}});const i=r.width,e=r.height,c=f;o.push({img:r,width:i,height:e,label:c,baseImage:n.base_image})}}let l=performance.now();console.log(`${o.length} pieces loaded in ${l-d} ms`),this.pieces=o}async switchVideoDevice(){await nt(this)}async loop(){if(this.running){if(!this.video||!this.canvas_process){console.error("No video or canvas");return}await ht(this,this.video),await this.draw(),await this.render()}}async draw(){await ut(this)}async render(){if(!this.canvas_process||!this.canvas_render){console.error("No canvas or rendering canvas");return}const a=this.canvas_process,d=this.canvas_render,g=d.getContext("2d"),o=a.getContext("2d");if(!g||!o){console.error("No context");return}const l=a.width/a.height,h=d.height,f=h*l,y=(d.width-f)/2;g.drawImage(a,y,0,f,h)}async downloadImage(){if(this.running=!1,!this.canvas_render){console.error("No rendering canvas");return}const a=this.canvas_render,d=document.createElement("a");d.href=a.toDataURL();const g={weekday:"long",day:"numeric",month:"long",hour:"2-digit",minute:"2-digit"},o=new Date().toLocaleString("en-GB",g);d.download=`image ${o}.png`,d.click()}async shareImage(){if(this.running=!1,!this.canvas_render){console.error("No rendering canvas");return}const d=this.canvas_render.toDataURL(),g={weekday:"long",day:"numeric",month:"long",hour:"2-digit",minute:"2-digit"},o=new Date().toLocaleString("en-GB",g),l=await fetch(d).then(y=>y.blob()),f={files:[new File([l],`image ${o}.png`,{type:"image/png"})],title:`image ${o}`,text:`image ${o}`};try{await navigator.share(f),console.log("Shared successfully")}catch(y){console.error("Error sharing",y)}}}const wt=D("span",{class:"loading"},"Loading...",-1),yt=[wt],vt=["src","alt"],bt=Be({__name:"Camera",emits:["newSlice","pictureTaken","updateList"],setup(t,{expose:a,emit:d}){const g=Le(),o=new _t,l=E(null),h=E(null),f=E(null),y=d;He(async()=>{console.log("mounted Camera.vue",g.props.corpses),l.value&&h.value&&f.value&&g.props.corpses&&(await o.init(l.value,h.value,f.value,g.props.corpses),requestAnimationFrame(u))});const u=async()=>{l.value&&h.value&&(await o.loop(),o.running&&y("updateList",o.currentlyShownPieces),requestAnimationFrame(u))},n=E([]);return a({takePhoto:()=>{console.log("take photo"),o.running=!o.running},switchDevice:()=>{o.switchVideoDevice()},downloadImage:()=>{o.downloadImage()},shareImage:()=>{o.shareImage()}}),(s,p)=>(S(),W(fe,null,[D("div",{ref_key:"video_container",ref:l,class:"video-container"},null,512),D("div",{ref_key:"div_process",ref:h,class:"div-process"},null,512),D("div",{ref_key:"div_render",ref:f,class:"div-render"},yt,512),(S(!0),W(fe,null,xe(n.value,v=>(S(),W("div",{key:v.part},[D("img",{src:v.img,alt:v.part},null,8,vt)]))),128))],64))}}),kt=async(t,a,d,g)=>{console.log("corpse",t),console.log(a.clientHeight);const o=document.createElement("canvas");o.id="collage-canvas",o.width=g.x,o.height=g.y,a.innerHTML="",a==null||a.appendChild(o);const l=o.getContext("2d");if(!l){console.error("no ctx");return}let h=Object.keys(t);if(d.length>0){let x=h[Math.floor(Math.random()*h.length)],P=d[Math.floor(Math.random()*d.length)],M=t[x],V=new Image;V.src=P.img,await new Promise(ue=>{V.onload=()=>{ue()}}),V.width,V.height,M.label;const z={...M,path:P.img,base_image:{...M.base_image,path:P.img}},Z={...t,[x]:z},ee=[...h],ne=ee.indexOf(x);ne!==-1&&ee.splice(ne,1),ee.push(x),t=Z,h=ee}console.log("keys",h);let f=[];for(let x=0;x<h.length;x++){const P=h[x],M=t[P],V=new Image;V.src=M.path,await new Promise(ne=>{V.onload=()=>{ne()}});const z=V.width,Z=V.height,ee=P;f.push({img:V,width:z,height:Z,label:ee})}f=f.sort(()=>Math.random()-.5);const y=o.width,u=o.height,n={x:y/2,y:u/2};let r={};for(let x=0;x<f.length;x++){const P=f[x];let M=P.width;P.width=y,P.height=P.height*(P.width/M),r[P.label]=P}console.log("pieces",f),l.fillStyle="gray",l.fillRect(0,0,y,u);let i=0,e=0,c=0,s=0,p="empty",v=.05,b={min:.9,max:1.1},T=1,k=0,_=0,m={},H=1,j=10,B=0,C=!1,$=.15,A=.15;for(p="middle",H=r[p].height/r[p].width,k=y*(Math.random()*(.65-.45)+.45),_=k*H,c=k*T,s=_*(c/k),i=n.x-c/2,e=n.y-s/2,l.fillStyle="red",l.fillRect(i,e,c,s),m[p]={x:i,y:e,width:c,height:s},p="top",H=r[p].height/r[p].width,_=m.middle.y-0-u*v,k=_/H,s=_*T,c=k*(s/_),C=!1,B=0,A=0,$=.35,b={min:.75,max:1};!C&&B<j;)c=m.middle.width*(Math.random()*(b.max-b.min)+b.min),s=c*(_/k),i=Math.random()*(m.middle.width-c)+m.middle.x,e=m.middle.y-s,e+=s*$*Math.random(),C=!0,B++;if(!C){console.error("Could not find a valid position");return}for(l.fillStyle="blue",l.fillRect(i,e,c,s),m[p]={x:i,y:e,width:c,height:s},p="left",H=r[p].height/r[p].width,k=m.middle.x-0-y*v,_=k*H,c=k*T,s=_*(c/k),C=!1,B=0,A=.35,b={min:.75,max:1};!C&&B<j;)c=m.middle.width*(Math.random()*(b.max-b.min)+b.min),s=c*(_/k),e=Math.random()*(m.middle.height-s)+m.middle.y,i=m.middle.x-c,i+=c*A*Math.random(),C=!0,B++;if(!C){console.error("Could not find a valid position");return}for(l.fillStyle="green",l.fillRect(i,e,c,s),m[p]={x:i,y:e,width:c,height:s},p="right",H=r[p].height/r[p].width,k=y-m.middle.x-m.middle.width-y*v,_=k*H,c=k*T,s=_*(c/k),C=!1,B=0,A=.65,b={min:.75,max:1};!C&&B<j;)c=m.middle.width*(Math.random()*(b.max-b.min)+b.min),s=c*(_/k),e=Math.random()*(m.middle.height-s)+m.middle.y,i=m.middle.x+m.middle.width,i-=c*A*Math.random(),C=!0,B++;if(!C){console.error("Could not find a valid position");return}l.fillStyle="purple",l.fillRect(i,e,c,s),m[p]={x:i,y:e,width:c,height:s},p="low",H=r[p].height/r[p].width;let U=(u-m.middle.y-m.middle.height-u*v/2)/2;for(_=U,k=_/H,s=_*T,c=k*(s/_),C=!1,B=0,$=.55,b={min:.75,max:1};!C&&B<j;)c=m.middle.width*(Math.random()*(b.max-b.min)+b.min),s=c*(_/k),i=Math.random()*(m.middle.width-c)+m.middle.x,e=m.middle.y+m.middle.height,e-=s*$*Math.random(),C=!0,B++;if(!C){console.error("Could not find a valid position");return}for(l.fillStyle="yellow",l.fillRect(i,e,c,s),m[p]={x:i,y:e,width:c,height:s},p="lowlow",H=r[p].height/r[p].width,_=U,k=_/H,s=_*T,c=k*(s/_),C=!1,B=0,$=.5,b={min:.75,max:1};!C&&B<j;)c=m.low.width*(Math.random()*(b.max-b.min)+b.min),s=c*(_/k),i=Math.random()*(m.low.width-c)+m.low.x,e=m.low.y+m.low.height,e-=s*$*Math.random(),C=!0,B++;l.fillStyle="orange",l.fillRect(i,e,c,s),m[p]={x:i,y:e,width:c,height:s};let O=Object.keys(m),K=1/0,Q=1/0;for(let x=0;x<O.length;x++){const P=O[x],M=m[P];M.x<K&&(K=M.x),M.y<Q&&(Q=M.y)}for(let x=0;x<O.length;x++){const P=O[x],M=m[P];M.x-=K,M.y-=Q}let J=document.createElement("canvas"),R=0,Y=0;for(let x=0;x<O.length;x++){const P=O[x],M=m[P];M.x+M.width>R&&(R=M.x+M.width),M.y+M.height>Y&&(Y=M.y+M.height)}J.width=R,J.height=Y,console.log("totalWidth",R),console.log("totalHeight",Y);let G=J.getContext("2d");if(!G){console.error("no buffer ctx");return}let N=["middle","top","left","right","low","lowlow"];N=N.sort(()=>Math.random()-.5);for(let x=0;x<N.length;x++){const P=N[x],M=m[P];let V=M.x,z=M.y;G.drawImage(r[P].img,V,z,M.width*T,M.height*T)}let ie=1;v=.05,(R>y-y*v||Y>u-u*v)&&(ie=Math.min((y-y*v)/R,(u-u*v)/Y));let oe=R*ie,ge=Y*ie,I=(y-oe)/2,se=(u-ge)/2;return l.fillStyle="gray",l.fillRect(0,0,y,u),l.drawImage(J,I,se,oe,ge),new Promise(x=>{x()})},xt=async(t,a,d,g)=>{console.log("createCollageBoundingBoxes"),console.log("corpse",t),console.log("collage_container",a),console.log("boundingBoxes",d),console.log("startingSize",g);const o=document.createElement("canvas");o.width=g.x,o.height=g.y,o.id="collage-canvas",a.innerHTML="",a.appendChild(o);const l=o.getContext("2d");if(!l){console.error("No context");return}let h=Object.keys(t);console.log("keys",h);let f=[];for(let u=0;u<h.length;u++){const n=h[u],r=t[n],i=new Image;i.src=r.path,await new Promise(p=>{i.onload=()=>{p()}});const e=i.width,c=i.height,s=n;f.push({img:i,width:e,height:c,label:s})}f=f.sort(()=>Math.random()-.5),console.log("pieces",f);const y=d.filter(u=>u.x!==1/0&&u.y!==1/0&&u.width!==1/0&&u.height!==1/0);console.log("filteredBoundingBoxes",y);for(let u=0;u<y.length;u++){const n=y[u];let r=!1,i=null;switch(l.strokeStyle="blue",l.strokeRect(n.x,n.y,n.width,n.height),n.label){case"head_processed":if(r="head",i=f.find(e=>e.label===r),i){const e=Math.min(n.width/i.width,n.height/i.height),c=i.width*e,s=i.height*e,p=n.x+(n.width-c)/2,v=n.y+n.height-s;l.drawImage(i.img,p,v,c,s)}break;case"torso_processed":if(r="torso",i=f.find(e=>e.label===r),i){const e=Math.min(n.width/i.width,n.height/i.height),c=i.width*e,s=i.height*e,p=n.x+(n.width-c)/2,v=n.y+(n.height-s)/2;l.drawImage(i.img,p,v,c,s)}break;case"right_arm_processed":if(r="right_arm",i=f.find(e=>e.label===r),i){const e=Math.min(n.width/i.width,n.height/i.height),c=i.width*e,s=i.height*e,p=n.x+n.width-c,v=n.y+(n.height-s)/2;l.drawImage(i.img,p,v,c,s)}break;case"left_arm_processed":if(r="left_arm",i=f.find(e=>e.label===r),i){const e=Math.min(n.width/i.width,n.height/i.height),c=i.width*e,s=i.height*e,p=n.x,v=n.y+(n.height-s)/2;l.drawImage(i.img,p,v,c,s)}break;case"right_leg_processed":if(r="right_leg",i=f.find(e=>e.label===r),i){const e=Math.min(n.width/i.width,n.height/i.height),c=i.width*e,s=i.height*e,p=n.x+n.width-c,v=n.y;l.drawImage(i.img,p,v,c,s)}break;case"left_leg_processed":if(r="left_leg",i=f.find(e=>e.label===r),i){const e=Math.min(n.width/i.width,n.height/i.height),c=i.width*e,s=i.height*e,p=n.x,v=n.y;l.drawImage(i.img,p,v,c,s)}break;case"right_foot_processed":if(r="right_foot",i=f.find(e=>e.label===r),i){const e=Math.min(n.width/i.width,n.height/i.height),c=i.width*e,s=i.height*e,p=n.x+(n.width-c)/2,v=n.y+(n.height-s)/2;l.drawImage(i.img,p,v,c,s)}break;case"left_foot_processed":if(r="left_foot",i=f.find(e=>e.label===r),i){const e=Math.min(n.width/i.width,n.height/i.height),c=i.width*e,s=i.height*e,p=n.x+(n.width-c)/2,v=n.y+(n.height-s)/2;l.drawImage(i.img,p,v,c,s)}break;case"right_hand_processed":if(r="right_hand",i=f.find(e=>e.label===r),i){const e=Math.min(n.width/i.width,n.height/i.height),c=i.width*e,s=i.height*e,p=n.x+(n.width-c)/2,v=n.y+(n.height-s)/2;l.drawImage(i.img,p,v,c,s)}break;case"left_hand_processed":if(r="left_hand",i=f.find(e=>e.label===r),i){const e=Math.min(n.width/i.width,n.height/i.height),c=i.width*e,s=i.height*e,p=n.x+(n.width-c)/2,v=n.y+(n.height-s)/2;l.drawImage(i.img,p,v,c,s)}break;default:r=!1}}},Mt={class:"morphing-mirror-layout"},Dt=D("header",null,null,-1),It=["hidden"],Pt=D("p",null,"Welcome!",-1),Ct=D("p",null,"Use your body to explore our archive.",-1),Bt=D("p",null,"The Magic MUrror will match your pose with images of our archive",-1),Lt=D("p",null,"Love, MU.",-1),Ht=["hidden"],St={key:0,class:"slices"},Wt=["hidden"],Tt=["hidden"],Vt={class:"list-container"},Rt=["href"],Yt={class:"nav"},Nt={key:0,class:"group"},Xt={key:1,class:"group"},Et={key:2,class:"group"},$t={class:"title"},Ot=D("strong",null,"Magical Morphing MUrror",-1),Gt=Be({__name:"MorphingMirror",setup(t){new it;const a=E(null),d=Le(),g=E([]),o=E("welcome"),l=E(null);He(async()=>{document.body.classList.add("mirror"),await qe()}),Ke(()=>{document.body.classList.remove("mirror")});const h=E(!1),f=async()=>{if(h.value)return;if(h.value=!0,!a.value){console.error("no collage container");return}if(!d.props.corpse){console.error("no corpse");return}let k=document.getElementById("canvas_process");if(!k){console.error("no container");return}let _={x:k.offsetWidth,y:k.offsetHeight};await kt(d.props.corpse,a.value,g.value,_),o.value="collage",h.value=!1},y=()=>{window.location.reload()},u=async k=>{if(console.log("picture taken",k),h.value)return;if(h.value=!0,!a.value){console.error("no collage container");return}if(!d.props.corpse){console.error("no corpse");return}let _=document.getElementById("canvas_process");if(!_){console.error("no container");return}let m={x:_.offsetWidth,y:_.offsetHeight};await xt(d.props.corpse,a.value,k,m),o.value="collage",h.value=!1},n=()=>{console.log("take picture"),l.value&&l.value.takePhoto()},r=()=>{console.log("switch device"),l.value&&l.value.switchDevice()},i=()=>{console.log("download image"),l.value&&l.value.downloadImage()},e=()=>{console.log("share image"),l.value&&l.value.shareImage()},c=()=>{o.value="camera"},s=E(!1),p=E([]),v=k=>{p.value=[],Object.keys(k).forEach(_=>{let m=k[_].baseImage,H=Math.floor(Math.random()*1e6);p.value.push({id:m.id,random:H,name:m.name,link:m.link})})},b={weekday:"long",day:"numeric",month:"long",hour:"2-digit",minute:"2-digit"},T=E(new Date().toLocaleString("en-GB",b));return setInterval(()=>{T.value=new Date().toLocaleString("en-GB",b)},1e3),(k,_)=>(S(),W("div",Mt,[Dt,D("main",null,[D("div",{class:"screen welcome",hidden:o.value!="welcome"},[Pt,Ct,Bt,Lt,D("button",{onClick:c},"Start")],8,It),o.value=="camera"?(S(),W("div",{key:0,class:"screen",hidden:o.value!="camera"},[Qe(bt,{ref_key:"cameraRef",ref:l,onUpdateList:v,onPictureTaken:u},null,512),g.value.length?(S(),W("div",St,[(S(!0),W(fe,null,xe(g.value,m=>(S(),W("div",{key:m.part,class:"slice",style:Je(`background-image: url('${m.img}')`)},null,4))),128))])):X("",!0),g.value.length?(S(),W("button",{key:1,class:"collage-button",onClick:f},"Make Collage")):X("",!0)],8,Ht)):X("",!0),D("div",{class:"screen",hidden:o.value!="collage"},[D("div",{ref_key:"collage_container",ref:a,class:"collage collage-container"},null,512),g.value.length?(S(),W("button",{key:0,class:"redo-button",onClick:_[0]||(_[0]=m=>o.value="camera")},"Start Over")):X("",!0),g.value.length?(S(),W("button",{key:1,class:"redo-button",onClick:_[1]||(_[1]=m=>o.value="camera")},"Go back")):X("",!0),g.value.length?(S(),W("button",{key:2,class:"start-over-button",onClick:_[2]||(_[2]=m=>y())},"Start over with new corpse")):X("",!0),g.value.length?(S(),W("button",{key:3,class:"list-button",onClick:_[3]||(_[3]=m=>o.value="list")},"List")):X("",!0)],8,Wt),D("div",{class:"screen",hidden:!s.value},[D("div",Vt,[p.value?(S(!0),W(fe,{key:0},xe(p.value,m=>(S(),W("div",{key:m.random},[D("a",{href:m.link,target:"_blank"},ke(m.name)+" "+ke(m.random),9,Rt)]))),128)):X("",!0)]),g.value.length?(S(),W("button",{key:0,class:"list-button",onClick:_[4]||(_[4]=m=>o.value="collage")},"Go Back")):X("",!0)],8,Tt)]),D("footer",null,[D("div",Yt,[o.value!="welcome"?(S(),W("div",Nt,[D("button",{onClick:n},"pht"),D("button",{onClick:r},"swtch")])):X("",!0),o.value!="welcome"?(S(),W("div",Xt,[D("button",{onClick:_[5]||(_[5]=m=>s.value=!1)},"img"),D("button",{onClick:_[6]||(_[6]=m=>s.value=!s.value)},"lst")])):X("",!0),o.value!="welcome"?(S(),W("div",Et,[D("button",{onClick:i},"down"),D("button",{onClick:e},"up")])):X("",!0)]),D("span",$t,[Ot,D("span",null,ke(T.value),1)])])]))}});export{Gt as default};
