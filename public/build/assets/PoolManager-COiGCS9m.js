var E=Object.defineProperty;var q=(w,a,t)=>a in w?E(w,a,{enumerable:!0,configurable:!0,writable:!0,value:t}):w[a]=t;var p=(w,a,t)=>(q(w,typeof a!="symbol"?a+"":a,t),t);import{_ as O}from"./PoolLayout.vue_vue_type_script_setup_true_lang-MyEA7auJ.js";import{_ as T}from"./BaseImageDetails.vue_vue_type_script_setup_true_lang-BFOqER_C.js";import{ds as R,dt as Y,cY as F,du as X,dv as A,dw as L}from"./register_all_kernels-BwOSmF9o.js";import{S as U,k as G,q as V,N as H,U as W}from"./body-segmentation.esm-D2El9hp6.js";import{z,y as K,d as Q,Q as J,l as C,m as Z,o as b,c as ee,w as ae,b as f,t as M,u as B,g as x,F as I,s as $,a as te,n as se,h as j,A as oe}from"./app-BVy8CyRw.js";/** @license See the LICENSE file. */const ne="4.19.0";/**
 * @license
 * Copyright 2018 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */const ie=Object.freeze(Object.defineProperty({__proto__:null,GraphModel:R,deregisterOp:Y,loadGraphModel:F,loadGraphModelSync:X,registerOp:A,version_converter:ne},Symbol.toStringTag,{value:"Module"}));var D={exports:{}};const le=z(ie),de=z(L);/**
 * @license
 * Copyright 2023 Google LLC. All Rights Reserved.
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 * =============================================================================
 */(function(w,a){(function(t,l){l(a,le,de)})(K,function(t,l,e){const n={1:{name:"/m/01g317",id:1,displayName:"person"},2:{name:"/m/0199g",id:2,displayName:"bicycle"},3:{name:"/m/0k4j",id:3,displayName:"car"},4:{name:"/m/04_sv",id:4,displayName:"motorcycle"},5:{name:"/m/05czz6l",id:5,displayName:"airplane"},6:{name:"/m/01bjv",id:6,displayName:"bus"},7:{name:"/m/07jdr",id:7,displayName:"train"},8:{name:"/m/07r04",id:8,displayName:"truck"},9:{name:"/m/019jd",id:9,displayName:"boat"},10:{name:"/m/015qff",id:10,displayName:"traffic light"},11:{name:"/m/01pns0",id:11,displayName:"fire hydrant"},13:{name:"/m/02pv19",id:13,displayName:"stop sign"},14:{name:"/m/015qbp",id:14,displayName:"parking meter"},15:{name:"/m/0cvnqh",id:15,displayName:"bench"},16:{name:"/m/015p6",id:16,displayName:"bird"},17:{name:"/m/01yrx",id:17,displayName:"cat"},18:{name:"/m/0bt9lr",id:18,displayName:"dog"},19:{name:"/m/03k3r",id:19,displayName:"horse"},20:{name:"/m/07bgp",id:20,displayName:"sheep"},21:{name:"/m/01xq0k1",id:21,displayName:"cow"},22:{name:"/m/0bwd_0j",id:22,displayName:"elephant"},23:{name:"/m/01dws",id:23,displayName:"bear"},24:{name:"/m/0898b",id:24,displayName:"zebra"},25:{name:"/m/03bk1",id:25,displayName:"giraffe"},27:{name:"/m/01940j",id:27,displayName:"backpack"},28:{name:"/m/0hnnb",id:28,displayName:"umbrella"},31:{name:"/m/080hkjn",id:31,displayName:"handbag"},32:{name:"/m/01rkbr",id:32,displayName:"tie"},33:{name:"/m/01s55n",id:33,displayName:"suitcase"},34:{name:"/m/02wmf",id:34,displayName:"frisbee"},35:{name:"/m/071p9",id:35,displayName:"skis"},36:{name:"/m/06__v",id:36,displayName:"snowboard"},37:{name:"/m/018xm",id:37,displayName:"sports ball"},38:{name:"/m/02zt3",id:38,displayName:"kite"},39:{name:"/m/03g8mr",id:39,displayName:"baseball bat"},40:{name:"/m/03grzl",id:40,displayName:"baseball glove"},41:{name:"/m/06_fw",id:41,displayName:"skateboard"},42:{name:"/m/019w40",id:42,displayName:"surfboard"},43:{name:"/m/0dv9c",id:43,displayName:"tennis racket"},44:{name:"/m/04dr76w",id:44,displayName:"bottle"},46:{name:"/m/09tvcd",id:46,displayName:"wine glass"},47:{name:"/m/08gqpm",id:47,displayName:"cup"},48:{name:"/m/0dt3t",id:48,displayName:"fork"},49:{name:"/m/04ctx",id:49,displayName:"knife"},50:{name:"/m/0cmx8",id:50,displayName:"spoon"},51:{name:"/m/04kkgm",id:51,displayName:"bowl"},52:{name:"/m/09qck",id:52,displayName:"banana"},53:{name:"/m/014j1m",id:53,displayName:"apple"},54:{name:"/m/0l515",id:54,displayName:"sandwich"},55:{name:"/m/0cyhj_",id:55,displayName:"orange"},56:{name:"/m/0hkxq",id:56,displayName:"broccoli"},57:{name:"/m/0fj52s",id:57,displayName:"carrot"},58:{name:"/m/01b9xk",id:58,displayName:"hot dog"},59:{name:"/m/0663v",id:59,displayName:"pizza"},60:{name:"/m/0jy4k",id:60,displayName:"donut"},61:{name:"/m/0fszt",id:61,displayName:"cake"},62:{name:"/m/01mzpv",id:62,displayName:"chair"},63:{name:"/m/02crq1",id:63,displayName:"couch"},64:{name:"/m/03fp41",id:64,displayName:"potted plant"},65:{name:"/m/03ssj5",id:65,displayName:"bed"},67:{name:"/m/04bcr3",id:67,displayName:"dining table"},70:{name:"/m/09g1w",id:70,displayName:"toilet"},72:{name:"/m/07c52",id:72,displayName:"tv"},73:{name:"/m/01c648",id:73,displayName:"laptop"},74:{name:"/m/020lf",id:74,displayName:"mouse"},75:{name:"/m/0qjjc",id:75,displayName:"remote"},76:{name:"/m/01m2v",id:76,displayName:"keyboard"},77:{name:"/m/050k8",id:77,displayName:"cell phone"},78:{name:"/m/0fx9l",id:78,displayName:"microwave"},79:{name:"/m/029bxz",id:79,displayName:"oven"},80:{name:"/m/01k6s3",id:80,displayName:"toaster"},81:{name:"/m/0130jx",id:81,displayName:"sink"},82:{name:"/m/040b_t",id:82,displayName:"refrigerator"},84:{name:"/m/0bt_c3",id:84,displayName:"book"},85:{name:"/m/01x3z",id:85,displayName:"clock"},86:{name:"/m/02s195",id:86,displayName:"vase"},87:{name:"/m/01lsmm",id:87,displayName:"scissors"},88:{name:"/m/0kmg4",id:88,displayName:"teddy bear"},89:{name:"/m/03wvsk",id:89,displayName:"hair drier"},90:{name:"/m/012xff",id:90,displayName:"toothbrush"}};class d{constructor(i,s){this.modelPath=s||`https://storage.googleapis.com/tfjs-models/savedmodel/${this.getPrefix(i)}/model.json`}getPrefix(i){return i==="lite_mobilenet_v2"?`ssd${i}`:`ssd_${i}`}async load(){this.model=await l.loadGraphModel(this.modelPath);const i=e.zeros([1,300,300,3],"int32"),s=await this.model.executeAsync(i);await Promise.all(s.map(o=>o.data())),s.map(o=>o.dispose()),i.dispose()}async infer(i,s,o){const c=e.tidy(()=>(i instanceof e.Tensor||(i=e.browser.fromPixels(i)),e.expandDims(i))),r=c.shape[1],g=c.shape[2],h=await this.model.executeAsync(c),N=h[0].dataSync(),u=h[1].dataSync();c.dispose(),e.dispose(h);const[y,k]=this.calculateMaxScores(N,h[0].shape[1],h[0].shape[2]),_=e.getBackend();e.getBackend()==="webgl"&&e.setBackend("cpu");const S=e.tidy(()=>{const v=e.tensor2d(u,[h[1].shape[1],h[1].shape[3]]);return e.image.nonMaxSuppression(v,y,s,o,o)}),P=S.dataSync();return S.dispose(),_!==e.getBackend()&&e.setBackend(_),this.buildDetectedObjects(g,r,u,y,P,k)}buildDetectedObjects(i,s,o,c,r,g){const h=r.length,N=[];for(let u=0;u<h;u++){const y=[];for(let v=0;v<4;v++)y[v]=o[4*r[u]+v];const k=y[0]*s,_=y[1]*i,S=y[2]*s,P=y[3]*i;y[0]=_,y[1]=k,y[2]=P-_,y[3]=S-k,N.push({bbox:y,class:n[g[r[u]]+1].displayName,score:c[r[u]]})}return N}calculateMaxScores(i,s,o){const c=[],r=[];for(let g=0;g<s;g++){let h=Number.MIN_VALUE,N=-1;for(let u=0;u<o;u++)i[g*o+u]>h&&(h=i[g*o+u],N=u);c[g]=h,r[g]=N}return[c,r]}async detect(i,s=20,o=.5){return this.infer(i,s,o)}dispose(){this.model!=null&&this.model.dispose()}}t.ObjectDetection=d,t.load=async function(m={}){if(e==null)throw new Error("Cannot find TensorFlow.js. If you are using a <script> tag, please also include @tensorflow/tfjs on the page before using this model.");const i=m.base||"lite_mobilenet_v2",s=m.modelUrl;if(["mobilenet_v1","mobilenet_v2","lite_mobilenet_v2"].indexOf(i)===-1)throw new Error(`ObjectDetection constructed with invalid base model ${i}. Valid names are 'mobilenet_v1', 'mobilenet_v2' and 'lite_mobilenet_v2'.`);const o=new d(i,s);return await o.load(),o},t.version="2.2.3",Object.defineProperty(t,"__esModule",{value:!0})})})(D,D.exports);var me=D.exports;class re{constructor(){p(this,"cocoSsdModel",null);p(this,"drawCanvas",!1);p(this,"canvasses",null);p(this,"bodySegmenter",null);p(this,"bodySegmentationModel",U.BodyPix);p(this,"bodySegmentationModelConfig",{architecture:"ResNet50",outputStride:16,quantBytes:4});p(this,"bodySegmentationConfig",{multiSegmentation:!0,segmentBodyParts:!0,flipHorizontal:!1,internalResolution:"full",segmentationThreshold:.7,maxDetections:30,scoreThreshold:.2,nmsRadius:20,minKeypointScore:.5,refineSteps:20});p(this,"cutouts",[]);p(this,"getPixelData",async a=>{let t=await a.mask.toImageData();const l=t.width;t.height;const e=t.data;let n=[];for(let d=0;d<e.length;d+=4){let m={x:d/4%l,y:Math.floor(d/4/l),color:{r:e[d],g:e[d+1],b:e[d+2],a:e[d+3]}};n.push(m)}return n});p(this,"getBoundingBoxesRaw",async a=>{let t={};for(let l in labelTable){let e=a.filter(n=>n.color.r===parseInt(l));if(e.length>0){let n=e.reduce((s,o)=>o.x<s?o.x:s,e[0].x),d=e.reduce((s,o)=>o.x>s?o.x:s,e[0].x),m=e.reduce((s,o)=>o.y<s?o.y:s,e[0].y),i=e.reduce((s,o)=>o.y>s?o.y:s,e[0].y);t[labelTable[l]]={minX:n,maxX:d,minY:m,maxY:i}}}return console.log("Raw part bounding boxes:",t),t});p(this,"getBoundingBoxesCombinations",async a=>{let t={};for(let l in labelTableCombinations){let e=a.filter(n=>labelTableCombinations[l].includes(n.color.r));if(e.length>0){let n=e.reduce((s,o)=>o.x<s?o.x:s,e[0].x),d=e.reduce((s,o)=>o.x>s?o.x:s,e[0].x),m=e.reduce((s,o)=>o.y<s?o.y:s,e[0].y),i=e.reduce((s,o)=>o.y>s?o.y:s,e[0].y);t[l]={minX:n,maxX:d,minY:m,maxY:i,pixels:e}}}return console.log("Combinations part bounding boxes:",t),t});p(this,"drawMaskOnCanvas",async(a,t,l)=>{const e=await V(a,W,{r:255,g:255,b:255,a:0});await H(l,t,e,1,0)});p(this,"drawRawBoxes",async(a,t)=>{let l=document.createElement("canvas");if(!l){console.error("No img canvas");return}l.width=a.width,l.height=a.height;let e=l.getContext("2d");if(!e){console.error("No img ctx");return}e.drawImage(a,0,0,a.width,a.height),e.strokeStyle="red",e.lineWidth=2;for(let n in t){let{minX:d,maxX:m,minY:i,maxY:s}=t[n];e.strokeRect(d,i,m-d,s-i)}});p(this,"drawCombinedBoxes",async(a,t)=>{let l=document.createElement("canvas");if(!l){console.error("No img canvas");return}l.width=a.width,l.height=a.height;let e=l.getContext("2d");if(!e){console.error("No img ctx");return}e.drawImage(a,0,0,a.width,a.height),e.strokeStyle="green",e.lineWidth=2;for(let n in t){let{minX:d,maxX:m,minY:i,maxY:s}=t[n];e.strokeRect(d,i,m-d,s-i)}});p(this,"extractCutouts",async(a,t)=>{let l=document.createElement("canvas");if(!l){console.error("No img canvas");return}l.width=a.width,l.height=a.height;let e=l.getContext("2d");if(!e){console.error("No img ctx");return}e.drawImage(a,0,0,a.width,a.height);let n=[];for(let d in t){let{minX:m,maxX:i,minY:s,maxY:o}=t[d],c=document.createElement("canvas");c.width=i-m,c.height=o-s;let r=c.getContext("2d");if(!r){console.error("No part ctx");return}r.drawImage(a,m,s,i-m,o-s,0,0,i-m,o-s);let g={part:d,img:c.toDataURL()};n.push(g)}return console.log("cutouts",n),n});console.log("ImageProcessor constructor")}async init(){return console.log("init"),this.cocoSsdModel=await me.load(),console.log("cocoSsdModel loaded"),this.bodySegmenter=await G(this.bodySegmentationModel,this.bodySegmentationModelConfig),console.log("bodySegmenter loaded"),new Promise((a,t)=>{a(!0)})}async processImage(a){console.log("processImage"),a.complete?console.log("image is loaded"):(console.log("image is not loaded"),await new Promise(n=>{a.addEventListener("load",n)})),console.log("image is now loaded");const t=await this.detectHumans(a);if(!t){console.error("No persons detected");return}const l=await this.splitCanvasIntoPersons(a,t);let e=[];for(let n=0;n<l.length;n++){let d=await this.drawMasksFromImgData(l[n]);d&&e.push(...d)}return console.log("total cutouts",e),new Promise((n,d)=>{n(e)})}async detectHumans(a){if(!this.cocoSsdModel){console.error("cocoSsdModel is not loaded");return}const t=await this.cocoSsdModel.detect(a,50,.6);console.log("predictions",t);const l=t.filter(e=>e.class==="person");return this.drawCanvas&&this.drawBoundingBoxesFromObjectDetection(a,t),new Promise((e,n)=>{e(l)})}async drawBoundingBoxesFromObjectDetection(a,t){let l=document.createElement("canvas");l.width=a.width,l.height=a.height;let e=l.getContext("2d");if(!e){console.error("ctx is null");return}e.drawImage(a,0,0,a.width,a.height),t.forEach(n=>{const{bbox:d}=n,[m,i,s,o]=d;e.beginPath(),e.rect(m,i,s,o),n.class==="person"?e.strokeStyle="green":e.strokeStyle="red",e.lineWidth=2,e.stroke(),e.beginPath(),e.measureText(n.class).width,e.rect(m,i-20,s,20),e.fillStyle="black",e.fill(),e.font="16px Arial",e.fillStyle="white",e.fillText(`${n.class} (${Math.round(n.score*100)}%)`,m,i-10),e.fillStyle="black",e.fill(),e.font="16px Arial",e.fillStyle="white",e.fillText(`${n.class} (${Math.round(n.score*100)}%)`,m,i-10)})}async splitCanvasIntoPersons(a,t){const l=[];return t.forEach((e,n)=>{let d=document.createElement("canvas");d.width=e.bbox[2],d.height=e.bbox[3];let m=d.getContext("2d");if(!m){console.error("No ctx");return}m.drawImage(a,e.bbox[0],e.bbox[1],e.bbox[2],e.bbox[3],0,0,e.bbox[2],e.bbox[3]),l.push(d.toDataURL())}),new Promise((e,n)=>{e(l)})}async getSegmentationFromImage(a){if(!this.bodySegmenter){console.error("bodySegmenter is not loaded");return}const t=await this.bodySegmenter.segmentPeople(a,this.bodySegmentationConfig);return console.log("segmentation",t),new Promise((l,e)=>{l(t)})}async drawMasksFromImgData(a){const t=new Image;t.src=a,await new Promise(n=>{t.onload=n});const l=await this.getSegmentationFromImage(t);if(!l){console.error("No segmentation");return}let e=[];for(let n=0;n<l.length;n++){const d=l[n];let m=await this.getPixelData(d);await this.getBoundingBoxesRaw(m);let i=await this.getBoundingBoxesCombinations(m),s=document.createElement("canvas");s.width=t.width,s.height=t.height;let o=await this.extractCutouts(t,i);o&&e.push(...o)}return console.log("cutouts",e),this.cutouts.push(...e),new Promise((n,d)=>{n(e)})}}const ce=f("h1",null,"Pool Manager",-1),pe={class:"manager"},ue={key:0,class:"manager-images"},ge={key:0,class:"manager-image"},he={class:"masks"},ye=["hint","onClick"],be={class:"mask-img"},fe=["src"],xe={key:1},we=f("div",{class:"actions"},null,-1),Ne=f("br",null,null,-1),je=Q({__name:"PoolManager",setup(w){new re;const a=J(),t=C([]);Z(async()=>{console.log("page",a.props.baseImages),a.props.baseImages&&(t.value=a.props.baseImages.map(m=>({baseImage:m,isProcessed:!1,isUploaded:!1,cutouts:[]})))}),C([]);const l=m=>{let i=!m.included;oe.patch(route("maskimage.setincluded"),{id:m.id,included:i}).then(()=>{m.included=i}).catch(()=>{console.error("Failed to update included status")})},e=C(10),n=C(!0),d=()=>{var m;e.value+=10,(m=a.props.baseImages)!=null&&m.length&&e.value>a.props.baseImages.length&&(e.value=a.props.baseImages.length,n.value=!1)};return(m,i)=>(b(),ee(O,null,{default:ae(()=>{var s;return[f("div",null,[ce,f("span",null,"Total "+M(((s=B(a).props.baseImages)==null?void 0:s.length)??0)+" base images / Loaded "+M(e.value),1)]),f("div",pe,[B(a).props.baseImages?(b(),x("div",ue,[(b(!0),x(I,null,$(B(a).props.baseImages,(o,c)=>(b(),x(I,{key:o.id},[c<e.value?(b(),x("div",ge,[o.processed?(b(),x(I,{key:0},[te(T,{baseImage:o,onDeleted:r=>(m.$page.props.baseImages??[]).splice(c,1)},null,8,["baseImage","onDeleted"]),f("div",he,[o.mask_images?(b(!0),x(I,{key:0},$(o.mask_images,r=>(b(),x("div",{key:r.id+r.label,class:se(["mask",{included:r.included}]),hint:`${r.included?"Included":"Not Included"}`,onClick:g=>l(r)},[f("div",be,[f("img",{src:r.path,alt:"mask.title"},null,8,fe)]),f("span",null,M(r.label),1)],10,ye))),128)):(b(),x("strong",xe,"No masks for this base image"))]),we],64)):j("",!0)])):j("",!0)],64))),128))])):j("",!0),Ne,n.value?(b(),x("button",{key:1,onClick:d},"Load more")):j("",!0)])]}),_:1}))}});export{je as default};
