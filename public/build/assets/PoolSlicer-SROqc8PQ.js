import{d as E,l as h,m as O,D as R,o as c,g as i,b as u,Q as N,i as C,c as $,w as F,t as D,h as p,s as P,F as I,a as U,n as V,j as X,E as Y,A as S}from"./app-CF6YtaFa.js";import{_ as T}from"./PoolLayout.vue_vue_type_script_setup_true_lang-B7YuJLqs.js";import{_ as A}from"./BaseImageDetails.vue_vue_type_script_setup_true_lang-DXWOdO18.js";import{_ as j}from"./_plugin-vue_export-helper-DlAUqK2U.js";const z={class:"image-processor"},Q=E({__name:"ImageSlicer",props:{baseImage:{}},emits:["cutout"],setup(L,{emit:y}){const m=L,e=h(null);h(null);const d=h(null),t=h({start:{x:null,y:null},end:{x:null,y:null}}),k=y;O(()=>{console.log("props",m.baseImage),w()}),R(()=>m.baseImage,()=>{console.log("base image changed",m.baseImage),w()});const w=()=>{if(v(m.baseImage.path),v(m.baseImage.path),!e.value){console.error("no canvas");return}e.value.removeEventListener("mousemove",_),e.value.removeEventListener("click",l),e.value.removeEventListener("contextmenu",a=>{a.preventDefault(),b()}),e.value.addEventListener("mousemove",_),e.value.addEventListener("click",l),e.value.addEventListener("contextmenu",a=>{a.preventDefault(),b()})},v=a=>{const n=new Image;n.src=a,n.onload=()=>{var s;console.log("image loaded",n),d.value=n,e.value&&(e.value.width=d.value.width,e.value.height=d.value.height,(s=e.value.getContext("2d"))==null||s.drawImage(d.value,0,0))}},b=()=>{t.value.start.x=null,t.value.start.y=null,t.value.end.x=null,t.value.end.y=null,_(new MouseEvent("mousemove"))},_=a=>{if(!e.value){console.error("no canvas");return}if(!d.value){console.error("no image");return}const n=e.value.getContext("2d");if(n&&(n.clearRect(0,0,e.value.width,e.value.height),n.drawImage(d.value,0,0),!(t.value.start.x===null&&t.value.start.y===null)&&t.value.start.x!=null&&t.value.start.y!=null&&t.value.end.x===null&&t.value.end.y===null)){const s=e.value.getBoundingClientRect(),o=t.value.start.x,g=t.value.start.y,x=a.clientX-s.left,f=a.clientY-s.top;n.beginPath(),n.strokeStyle="red",n.lineWidth=4,n.fillStyle="white",n.rect(o,g,x-o,f-g),n.stroke();return}},l=a=>{if(console.log("set current mask",a),!e.value){console.error("no canvas");return}const n=e.value.getBoundingClientRect(),s=a.clientX-n.left,o=a.clientY-n.top;if(t.value.start.x===null&&t.value.start.y===null){t.value.start.x=s,t.value.start.y=o;return}else t.value.end.x=s,t.value.end.y=o,r(),t.value.start.x=null,t.value.start.y=null,t.value.end.x=null,t.value.end.y=null},r=()=>{if(console.log("cut out mask"),!e.value){console.error("no canvas");return}if(!d.value){console.error("no image");return}if(t.value.start.x===null||t.value.start.y===null){console.error("no start");return}if(t.value.end.x===null||t.value.end.y===null){console.error("no end");return}const a=e.value.getContext("2d");if(!a){console.error("no ctx");return}a.clearRect(0,0,e.value.width,e.value.height),a.drawImage(d.value,0,0);const n=Math.min(t.value.start.x,t.value.end.x),s=Math.min(t.value.start.y,t.value.end.y),o=Math.max(t.value.start.x,t.value.end.x),g=Math.max(t.value.start.y,t.value.end.y);console.table({minX:n,minY:s,maxX:o,maxY:g});const x=new Image;x.src=e.value.toDataURL(),x.onload=()=>{const f=document.createElement("canvas");f.width=o-n,f.height=g-s;const M=f.getContext("2d");if(!M){console.error("no cutout ctx");return}M.drawImage(x,n,s,o-n,g-s,0,0,o-n,g-s);const B={part:"unknown",img:f.toDataURL()};k("cutout",B)}};return(a,n)=>(c(),i("div",z,[u("canvas",{ref_key:"canvas",ref:e},null,512)]))}}),W=j(Q,[["__scopeId","data-v-b9f83adb"]]),q=u("h1",null,"Pool Slicer",-1),G={class:"processor"},H={class:"processor-images"},J={key:0,class:"processor-image"},K={class:"cutouts"},Z=u("h2",null,"Cutouts",-1),ee=["hint"],te={class:"cutout-img"},ne=["src"],ae={class:"cutout-actions"},se={class:"label-wrap"},le=u("label",null,"Label",-1),oe=["onUpdate:modelValue"],ue=["value"],re=["onClick"],ce={key:0},ie={class:"actions"},de=["onClick"],ve=["onClick","disabled"],me=u("br",null,null,-1),ge=u("br",null,null,-1),pe=["onClick"],he=u("br",null,null,-1),_e=["onClick"],ke=E({__name:"PoolSlicer",setup(L){const y=N(),m=["background","top","middle","low","lowlow","left","right"],e=h([]),d=h(!1);O(async()=>{console.log("page",y.props.baseImages),y.props.baseImages&&(e.value=y.props.baseImages.map(l=>({baseImage:l,isProcessed:!1,isUploaded:!1,cutouts:[]})),d.value=!0)});const t=async l=>{if(console.log("uploading",l),!b.value)if(confirm("This image does not have any slices yet, do you still want to process it?")===!0){k(l);return}else return;for(let r=0;r<l.cutouts.length;r++){const a=l.cutouts[r],n=new FormData;n.append("base_image_id",l.baseImage.id.toString()),n.append("label",a.part);const s=await fetch(a.img).then(o=>o.blob()).then(o=>new File([o],`${a.part}.png`,{type:"image/png"}));n.append("image",s),n.append("included",a.included?"1":"0");try{await S.post(route("pool.mask.upload"),n,{headers:{"Content-Type":"multipart/form-data"}}).then(o=>{console.log(o.data)}),await new Promise(o=>{setTimeout(()=>{o(!0)},100)})}catch(o){console.error(o)}}k(l)},k=async l=>{S.post(route("pool.markasprocessed",l.baseImage.id)).then(r=>{console.log(r.data)}),l.isProcessed=!0,e.value.splice(e.value.indexOf(l),1)},w=l=>{console.log("cutout",l),e.value[v.value].cutouts.push({part:l.part,img:l.img,included:!0})},v=h(0);C(()=>{const l=e.value[v.value];return l.cutouts.length>0&&l.cutouts.every(r=>m.includes(r.part))});const b=C(()=>{const l=e.value[v.value];return l.cutouts.length>0&&l.cutouts.every(r=>m.includes(r.part))}),_=C(()=>e.value[v.value].cutouts.length>0);return(l,r)=>(c(),$(T,null,{default:F(()=>[u("div",null,[q,u("span",null,D(e.value.length)+" to be processed",1)]),d.value&&e.value.length>0?(c(),$(W,{key:0,"base-image":e.value[v.value].baseImage,onCutout:r[0]||(r[0]=a=>w(a))},null,8,["base-image"])):p("",!0),u("div",G,[u("div",H,[(c(!0),i(I,null,P(e.value,(a,n)=>(c(),i(I,{key:a.baseImage.id},[n==v.value?(c(),i("div",J,[U(A,{baseImage:a.baseImage,onDeleted:s=>e.value.splice(n,1)},null,8,["baseImage","onDeleted"]),u("div",K,[Z,(c(!0),i(I,null,P(a.cutouts,s=>(c(),i("div",{key:s.part,class:V(["cutout",{included:s.included}]),hint:`${s.included?"Included":"Not Included"}`},[u("div",te,[u("img",{src:s.img,alt:"cutout.title"},null,8,ne)]),u("div",ae,[u("div",se,[le,X(u("select",{"onUpdate:modelValue":o=>s.part=o},[(c(),i(I,null,P(m,o=>u("option",{key:o,value:o},D(o),9,ue)),64))],8,oe),[[Y,s.part]])]),u("button",{onClick:o=>a.cutouts.splice(a.cutouts.indexOf(s),1),class:"danger"},"Remove Slice",8,re)])],10,ee))),128)),a.cutouts.length?p("",!0):(c(),i("strong",ce,"No slices yet"))]),u("div",ie,[_.value?p("",!0):(c(),i("button",{key:0,onClick:s=>t(a),class:"success"},"Process as empty",8,de)),_.value?(c(),i("button",{key:1,onClick:s=>t(a),class:"success",disabled:!b.value},"Process Slices",8,ve)):p("",!0),me,ge,n>0?(c(),i("button",{key:2,onClick:s=>v.value=n-1,class:"prev"},"Prev ",8,pe)):p("",!0),he,n<e.value.length-1?(c(),i("button",{key:3,onClick:s=>v.value=n+1,class:"next"},"Next",8,_e)):p("",!0)])])):p("",!0)],64))),128))])])]),_:1}))}});export{ke as default};
