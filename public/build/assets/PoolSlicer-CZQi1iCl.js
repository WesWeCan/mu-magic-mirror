import{d as E,l as h,m as O,D as R,o as c,g as i,b as u,Q as N,i as w,c as $,w as F,t as D,h as _,s as P,F as C,a as U,n as V,j as X,E as Y,A as S}from"./app-Bt6mra0n.js";import{_ as T}from"./PoolLayout.vue_vue_type_script_setup_true_lang-BFzpikBF.js";import{_ as A}from"./BaseImageDetails.vue_vue_type_script_setup_true_lang-CxnUkd6V.js";import{_ as j}from"./_plugin-vue_export-helper-DlAUqK2U.js";const z={class:"image-processor"},Q=E({__name:"ImageSlicer",props:{baseImage:{}},emits:["cutout"],setup(L,{emit:y}){const m=L,e=h(null);h(null);const d=h(null),t=h({start:{x:null,y:null},end:{x:null,y:null}}),k=y;O(()=>{console.log("props",m.baseImage),I()}),R(()=>m.baseImage,()=>{console.log("base image changed",m.baseImage),I()});const I=()=>{if(v(m.baseImage.path),v(m.baseImage.path),!e.value){console.error("no canvas");return}e.value.removeEventListener("mousemove",p),e.value.removeEventListener("click",l),e.value.removeEventListener("contextmenu",n=>{n.preventDefault(),b()}),e.value.addEventListener("mousemove",p),e.value.addEventListener("click",l),e.value.addEventListener("contextmenu",n=>{n.preventDefault(),b()})},v=n=>{const a=new Image;a.src=n,a.onload=()=>{var s;console.log("image loaded",a),d.value=a,e.value&&(e.value.width=d.value.width,e.value.height=d.value.height,(s=e.value.getContext("2d"))==null||s.drawImage(d.value,0,0))}},b=()=>{t.value.start.x=null,t.value.start.y=null,t.value.end.x=null,t.value.end.y=null,p(new MouseEvent("mousemove"))},p=n=>{if(!e.value){console.error("no canvas");return}if(!d.value){console.error("no image");return}const a=e.value.getContext("2d");if(a&&(a.clearRect(0,0,e.value.width,e.value.height),a.drawImage(d.value,0,0),!(t.value.start.x===null&&t.value.start.y===null)&&t.value.start.x!=null&&t.value.start.y!=null&&t.value.end.x===null&&t.value.end.y===null)){const s=e.value.getBoundingClientRect(),o=t.value.start.x,g=t.value.start.y,x=n.clientX-s.left,f=n.clientY-s.top;a.beginPath(),a.strokeStyle="red",a.lineWidth=4,a.fillStyle="white",a.rect(o,g,x-o,f-g),a.stroke();return}},l=n=>{if(console.log("set current mask",n),!e.value){console.error("no canvas");return}const a=e.value.getBoundingClientRect(),s=n.clientX-a.left,o=n.clientY-a.top;if(t.value.start.x===null&&t.value.start.y===null){t.value.start.x=s,t.value.start.y=o;return}else t.value.end.x=s,t.value.end.y=o,r(),t.value.start.x=null,t.value.start.y=null,t.value.end.x=null,t.value.end.y=null},r=()=>{if(console.log("cut out mask"),!e.value){console.error("no canvas");return}if(!d.value){console.error("no image");return}if(t.value.start.x===null||t.value.start.y===null){console.error("no start");return}if(t.value.end.x===null||t.value.end.y===null){console.error("no end");return}const n=e.value.getContext("2d");if(!n){console.error("no ctx");return}n.clearRect(0,0,e.value.width,e.value.height),n.drawImage(d.value,0,0);const a=Math.min(t.value.start.x,t.value.end.x),s=Math.min(t.value.start.y,t.value.end.y),o=Math.max(t.value.start.x,t.value.end.x),g=Math.max(t.value.start.y,t.value.end.y);console.table({minX:a,minY:s,maxX:o,maxY:g});const x=new Image;x.src=e.value.toDataURL(),x.onload=()=>{const f=document.createElement("canvas");f.width=o-a,f.height=g-s;const M=f.getContext("2d");if(!M){console.error("no cutout ctx");return}M.drawImage(x,a,s,o-a,g-s,0,0,o-a,g-s);const B={part:"unknown",img:f.toDataURL()};k("cutout",B)}};return(n,a)=>(c(),i("div",z,[u("canvas",{ref_key:"canvas",ref:e},null,512)]))}}),W=j(Q,[["__scopeId","data-v-b9f83adb"]]),q=u("h1",null,"Pool Slicer",-1),G={class:"processor"},H={class:"processor-images"},J={key:0,class:"processor-image"},K={class:"cutouts"},Z=u("h2",null,"Cutouts",-1),ee=["hint"],te={class:"cutout-img"},ae=["src"],ne={class:"cutout-actions"},se={class:"label-wrap"},le=u("label",null,"Label",-1),oe=["onUpdate:modelValue"],ue=["value"],re=["onClick"],ce={key:0},ie={class:"actions"},de=["onClick"],ve=["onClick","disabled"],me=u("br",null,null,-1),ge=u("br",null,null,-1),_e=["onClick"],he=u("br",null,null,-1),pe=["onClick"],ke=E({__name:"PoolSlicer",setup(L){const y=N(),m=["head","torso","right_arm","left_arm","right_leg","left_leg","right_hand","left_hand","right_foot","left_foot"],e=h([]),d=h(!1);O(async()=>{console.log("page",y.props.baseImages),y.props.baseImages&&(e.value=y.props.baseImages.map(l=>({baseImage:l,isProcessed:!1,isUploaded:!1,cutouts:[]})),d.value=!0)});const t=async l=>{if(console.log("uploading",l),!b.value)if(confirm("This image does not have any slices yet, do you still want to process it?")===!0){k(l);return}else return;for(let r=0;r<l.cutouts.length;r++){const n=l.cutouts[r],a=new FormData;a.append("base_image_id",l.baseImage.id.toString()),a.append("label",n.part);const s=await fetch(n.img).then(o=>o.blob()).then(o=>new File([o],`${n.part}.png`,{type:"image/png"}));a.append("image",s),a.append("included",n.included?"1":"0");try{await S.post(route("pool.mask.upload"),a,{headers:{"Content-Type":"multipart/form-data"}}).then(o=>{console.log(o.data)}),await new Promise(o=>{setTimeout(()=>{o(!0)},100)})}catch(o){console.error(o)}}k(l)},k=async l=>{S.post(route("pool.markasprocessed",l.baseImage.id)).then(r=>{console.log(r.data)}),l.isProcessed=!0,e.value.splice(e.value.indexOf(l),1)},I=l=>{console.log("cutout",l),e.value[v.value].cutouts.push({part:l.part,img:l.img,included:!0})},v=h(0);w(()=>{const l=e.value[v.value];return l.cutouts.length>0&&l.cutouts.every(r=>m.includes(r.part))});const b=w(()=>{const l=e.value[v.value];return l.cutouts.length>0&&l.cutouts.every(r=>m.includes(r.part))}),p=w(()=>e.value[v.value].cutouts.length>0);return(l,r)=>(c(),$(T,null,{default:F(()=>[u("div",null,[q,u("span",null,D(e.value.length)+" to be processed",1)]),d.value&&e.value.length>0?(c(),$(W,{key:0,"base-image":e.value[v.value].baseImage,onCutout:r[0]||(r[0]=n=>I(n))},null,8,["base-image"])):_("",!0),u("div",G,[u("div",H,[(c(!0),i(C,null,P(e.value,(n,a)=>(c(),i(C,{key:n.baseImage.id},[a==v.value?(c(),i("div",J,[U(A,{baseImage:n.baseImage,onDeleted:s=>e.value.splice(a,1)},null,8,["baseImage","onDeleted"]),u("div",K,[Z,(c(!0),i(C,null,P(n.cutouts,s=>(c(),i("div",{key:s.part,class:V(["cutout",{included:s.included}]),hint:`${s.included?"Included":"Not Included"}`},[u("div",te,[u("img",{src:s.img,alt:"cutout.title"},null,8,ae)]),u("div",ne,[u("div",se,[le,X(u("select",{"onUpdate:modelValue":o=>s.part=o},[(c(),i(C,null,P(m,o=>u("option",{key:o,value:o},D(o),9,ue)),64))],8,oe),[[Y,s.part]])]),u("button",{onClick:o=>n.cutouts.splice(n.cutouts.indexOf(s),1),class:"danger"},"Remove Slice",8,re)])],10,ee))),128)),n.cutouts.length?_("",!0):(c(),i("strong",ce,"No slices yet"))]),u("div",ie,[p.value?_("",!0):(c(),i("button",{key:0,onClick:s=>t(n),class:"success"},"Process as empty",8,de)),p.value?(c(),i("button",{key:1,onClick:s=>t(n),class:"success",disabled:!b.value},"Process Slices",8,ve)):_("",!0),me,ge,a>0?(c(),i("button",{key:2,onClick:s=>v.value=a-1,class:"prev"},"Prev ",8,_e)):_("",!0),he,a<e.value.length-1?(c(),i("button",{key:3,onClick:s=>v.value=a+1,class:"next"},"Next",8,pe)):_("",!0)])])):_("",!0)],64))),128))])])]),_:1}))}});export{ke as default};
